<!-- Standalone Generated By Octo (octo-ide.com) -->
<script>data={"program":"###########################################\n#\n#  Super NeatBoy\n#\n#  A platformer game engine example for Octo\n#\n#  'oh no; what has happened to all my leaves?\n#   I must find them and bring them back home!'\n#\n#  Move with A/D or arrows,\n#  Jump with E or space.\n#\n#  This program uses XO-Chip instructions,\n#  and expects to be run at around 500-1000\n#  cycles/frame. The plane 2 and blend\n#  colors should be identical to make\n#  the player sprite opaque. Additionally,\n#  the buzzer color should probably be set\n#  to match the background.\n#  The \"clip sprites at screen edges instead of wrapping\"\n#  compatibility flag will hide a minor aesthetic issue\n#  when the player moves between screens horizontally.\n#\n###########################################\n\n# v0-v4, vf reserved as temporaries.\n# v5-v6 are still available as globals.\n\n:alias stemp   v7 # temp register for sound effects\n:alias time    v8 # global frame counter for portal animation\n:alias px      v9 # player x position, in screen pixels\n:alias py      vA # player y position, in screen pixels\n:alias px_sign vB # {-1, 0, 1} on x axis\n:alias dx      vC # velocity on x axis, in pixels\n:alias frame   vD # player animation frame\n:alias flags   vE # movement status flags (see below)\n\n:const FLAG_LEFT     1 # is the player facing left? (otherwise, face right)\n:const FLAG_JUMPED   2 # has the player already jumped since last touching ground?\n:const FLAG_PRESSED  4 # is the player still holding down jump since last touching ground?\n:const FLAG_FELL     8 # did the player fall off a ledge, rather than jumping?\n\n# persistent state which doesn't need\n# to reside in a global register:\n\n: player-room     0 # room index\n: player-entrance 3 # last entrance direction\n: leaf-count      0 # for convenience, a total\n\n# note: storing the above variables in global\n# registers would be an easy way to save code space,\n# if they aren't needed for any other purpose...\n\n:const ROOM_COUNT 16\n\n: leaf-found\n\t# collectibles for victory condition,\n\t# stored as flags by room index.\n\t0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0\n\n: total-deaths    0\n: total-time-frac 0 # 1/60ths of a second (0-59)\n: total-time-sec  0 # full seconds        (0-59)\n: total-time-min  0 # full minutes\n\n:macro world-reset {\n\ti := player-room\n\tv0 := 0 # room\n\tv1 := 3 # entrance\n\tv2 := 0 # leaves\n\tsave v2\n\n\ti := leaf-found\n\tv0 := 0\n\tv1 := 0\n\tloop\n\t\tsave v0\n\t\tv1 += 1\n\t\t:calc ZERO_INIT { ROOM_COUNT + 4 } # clear deaths/time too\n\t\tif v1 != ZERO_INIT then\n\tagain\n}\n\n# note: changing this goal will require tweaking leaf-progress:\n:const LEAF_COUNT 8\n\n:const ENTER_RIGHT 0\n:const ENTER_LEFT  1\n:const ENTER_UP    2\n:const ENTER_DOWN  3\n\n# every room has up to four distinct player respawn\n# locations used whenever the player dies. (see { A, B, C, D })\n# the spawn point chosen is based on the direction\n# from which the player entered the room.\n# the X/Y spawn coordinates for the current room are stored here:\n: room-spawns\n\t0 0 # RIGHT\n\t0 0 # LEFT\n\t0 0 # UP\n\t0 0 # DOWN\n\n# to reduce flicker, this game always tracks the player's\n# location and animation frame after each update in this buffer.\n# this information can then be used to quickly erase the player sprite\n# immediately before redrawing:\n: player-prev\n\t0 # anim offset\n\t0 # x\n\t0 # y\n\n# when a player jumps, they leave behind a temporary\n# dust cloud animation:\n: player-dust\n\t0 # timer (see DUST_END)\n\t0 # x\n\t0 # y\n\n###########################################\n#\n#  Utility Macros\n#\n###########################################\n\n# convenience macros for manipulating the flag register:\n:macro set-flag FLAG {\n\tvf := FLAG\n\tflags |= vf\n}\n:macro clear-flag FLAG {\n\t:calc unflag { ~ FLAG }\n\tvf := unflag\n\tflags &= vf\n}\n:macro if-flag FLAG {\n\tvf := FLAG\n\tvf &= flags\n\tif vf != 0\n}\n:macro if-not-flag FLAG {\n\tvf := FLAG\n\tvf &= flags\n\tif vf == 0\n}\n\n# together, these two macros can be used to create a horizontally-mirrored\n# copy of an existing 8x8 sprite, like the player sprites:\n:macro mirror-row {\n\t:calc t { @ sprite-base }\n\t:byte { (   1 & t >> 7 ) | (  2 & t >> 5 ) | (  4 & t >> 3 ) | (  8 & t >> 1 ) |\n\t        ( 128 & t << 7 ) | ( 64 & t << 5 ) | ( 32 & t << 3 ) | ( 16 & t << 1 ) }\n\t:calc sprite-base { 1 + sprite-base }\n}\n:macro mirror-frame BASE {\n\t:calc sprite-base { player-frames + BASE }\n\tmirror-row  mirror-row  mirror-row  mirror-row\n\tmirror-row  mirror-row  mirror-row  mirror-row\n}\n\n# 'wait' will wait for at *least* TIME to elapse.\n# 'sync' will wait for at *most* TIME to elapse.\n:macro wait TIME {\n\tvf := TIME delay := vf\n\tloop vf := delay if vf != 0 then again\n}\n:macro sync TIME {\n\tloop vf := delay if vf != 0 then again\n\tvf := TIME delay := vf\n}\n\n# helpers for multiple memory indirection/pointers:\n# unpack16 places a computed 16-bit address in v registers,\n# pointer writes a computed 16-bit address into memory as a literal,\n# and indirect creates an i := long NNNN instruction with a label\n# halfway through, ready to be overwritten with a new 16-bit value:\n:macro unpack16 ADDR {\n\t:calc hi { 0xFF & ADDR >> 8 }  v0 := hi\n\t:calc lo { 0xFF & ADDR      }  v1 := lo\n}\n:macro pointer ADDR {\n\t:byte { 0xFF & ADDR >> 8 }\n\t:byte { 0xFF & ADDR      }\n}\n:macro indirect LABEL {\n\t0xF0 0x00 : LABEL 0x00 0x00 # i := long NNNN\n}\n\n# keep a value within boundaries\n:macro clamp REG MIN MINV MAX MAXV {\n\tif REG >= MIN begin\n\t\tREG := MINV\n\telse\n\t\tif REG >= MAX then REG := MAXV\n\tend\n}\n\n# helpers for working with XO-Chip high RAM.\n# the 'to-data' macro indicates that the ensuing data\n# should be assembled into high RAM (which must be indexed\n# with the i := long NNNN instruction),\n# and the 'to-code' macro swaps back to assembling in low RAM.\n# using these macros allows you to declare data before using it,\n# while keeping data out of precious low RAM:\n:calc CODE_POS { 0x200  }\n:calc DATA_POS { 0x1000 }\n:macro to-code { :calc DATA_POS { HERE }  :org { CODE_POS } }\n:macro to-data { :calc CODE_POS { HERE }  :org { DATA_POS } }\n\n###########################################\n#\n#  BATS!\n#\n###########################################\n\nto-data\n\n: bat-sprites\n\t0x5C 0xFE 0xFF 0x71 0x58 0x00 0x00 0x00\n\t0x00 0x3C 0xFE 0xFE 0x5F 0x00 0x00 0x00\n\t0x00 0x30 0xF8 0xF8 0x7A 0x5E 0x2C 0x00\n\t0x00 0x3C 0xFE 0xFE 0x5E 0x00 0x00 0x00\n\n: bat-wobble\n\t0 -1 -2 -1 0 1 2 1\n\nto-code\n\n: bat-stash    0   # flag\n: bat-stash-x  0 0 # x, y\n\n: bat-draw\n\ti := bat-stash\n\tload v2\n\tif v0 == 0 then return\n\tplane 2\n\n\t# slow vertical wobble\n\tv0 := 0b11100\n\tv0 &= v1 # x\n\tv0 >>= v0\n\tv0 >>= v0\n\ti := long bat-wobble\n\ti += v0\n\tload v0\n\tv2 += v0 # final y\n\n\t# frame cycle\n\ti := long bat-sprites\n\tv0 := 0b110\n\tv0 &= v1 # x\n\tv0 += v0 # * 2\n\tv0 += v0 # * 4\n\ti  += v0\n\n\tsprite v1 v2 8\n;\n\n:macro bat-clear {\n\tv0 := 0\n\ti := bat-stash\n\tsave v0\n}\n:macro bat-init {\n\tv0 := -1\n\ti := bat-stash\n\tsave v2\n}\n:macro bat-update {\n\tbat-draw\n\tv1 += -2\n\ti := bat-stash-x\n\tsave v1 - v1\n\tbat-draw\n}\n\n###########################################\n#\n#  Leaves\n#\n###########################################\n\nto-data\n\n: leaf-sprite\n\t0xC0 0xB4 0x5D 0x75 0x2F 0x7A 0x0E 0x39\n: out-of-8\n\t0x2F 0x49 0x4F 0x49 0x8F\n\nto-code\n\n:const STATUS_X 1\n:const STATUS_Y 122\n\n: leaf-stash\n\t0 # x\n\t0 # y\n\n: leaf-draw\n\ti := leaf-stash\n\tload v1\n\tif v1 == -1 then return\n\tplane 2\n\ti := long leaf-sprite\n\tsprite v0 v1 8\n;\n\n: leaf-clear\n\tv0 := -1\n\tv1 := -1\n\ti  := leaf-stash\n\tsave v1\n;\n\n: leaf-progress\n\ti := leaf-count\n\tload v0\n\ti := hex v0\n\tv1 := STATUS_X\n\tv2 := STATUS_Y\n\tsprite v1 v2 5\n\tv1 += 5\n\ti := long out-of-8\n\tsprite v1 v2 5\n;\n\n:macro leaf-init {\n\t# don't initialize if the leaf in this\n\t# room has already been taken:\n\ti := player-room\n\tload v0\n\ti := long leaf-found\n\ti += v0\n\tload v0\n\tif v0 == 0 begin\n\t\ti := leaf-stash\n\t\tsave v1 - v2\n\tend\n}\n:macro leaf-exists {\n\t# v0 != -1 iff there's a leaf here\n\ti := leaf-stash\n\tload v0\n}\n:macro leaf-get {\n\tsfx sound-get\n\n\t# flicker leaf\n\tv2 := 9\n\tloop\n\t\tleaf-draw\n\t\twait 3\n\n\t\tv2 += -1\n\t\tif v2 != 0 then\n\tagain\n\tleaf-clear\n\n\t# record pickup\n\ti := player-room\n\tload v0\n\ti := long leaf-found\n\ti += v0\n\tv0 := 1\n\tsave v0\n\ti := long leaf-count\n\tload v0 - v0\n\tv0 += 1\n\tsave v0 - v0\n\n\t# animate progress counter\n\tleaf-progress\n\twait 60\n\tleaf-progress\n}\n\n###########################################\n#\n#  Full-Screen Graphics\n#\n###########################################\n\nto-data\n\n# These screens were prepared using EZ-Pack:\n# http://beyondloom.com/tools/ezpack.html\n# starting with a 128x64 pixel black-and-white image,\n# use default settings aside from changing\n# \"Sprite Size\" to 0 for 16x16 sprites in each chunk.\n\n: title-data\n\t0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00\n\t0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00\n\t0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00\n\t0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00\n\t0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00\n\t0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00\n\t0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00\n\t0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00\n\t0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00\n\t0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00\n\t0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00\n\t0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00\n\t0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00\n\t0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00\n\t0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00\n\t0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00\n\t0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00\n\t0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x01 0x00 0x01 0x00 0x00 0x00 0x00\n\t0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00\n\t0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x01 0x00 0x01 0x00 0x01 0x00 0x00 0x00 0x00\n\t0x00 0x00 0x03 0xE7 0x03 0xF7 0x03 0x36 0x03 0x37 0x03 0x36 0x03 0x37 0x03 0x37\n\t0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00\n\t0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00\n\t0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00\n\t0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00\n\t0x00 0x00 0x00 0x00 0x70 0x07 0xF8 0x07 0xDB 0x06 0x9B 0x36 0x83 0x36 0xC3 0x36\n\t0xC3 0x36 0x63 0x36 0x73 0x36 0x3B 0x37 0x3B 0x37 0x1B 0x36 0x1B 0x36 0x1B 0x36\n\t0x1B 0x36 0x1B 0x36 0x9B 0x36 0x99 0xB6 0xD9 0xF6 0xF8 0xE6 0xF0 0x06 0x00 0x00\n\t0x00 0x00 0xCF 0x3F 0xDF 0xBF 0x19 0x8C 0x9F 0x8C 0x1F 0x8C 0xD9 0x8C 0xD9 0x8C\n\t0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00\n\t0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00\n\t0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00\n\t0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00\n\t0x00 0x00 0x00 0x00 0x80 0x3E 0xC7 0xBF 0xCF 0xB7 0x6C 0x31 0x6C 0x31 0x6C 0x31\n\t0x6E 0x31 0xCE 0x33 0xCC 0x33 0xCC 0x36 0x8C 0x3E 0x0C 0x3C 0x0C 0x36 0x0C 0x36\n\t0x0C 0x36 0x0C 0x33 0x0C 0x33 0x0C 0x31 0x0C 0x31 0x0F 0xB1 0x07 0xB0 0x00 0x00\n\t0x00 0x00 0x7C 0x00 0x7E 0x00 0x66 0x00 0x7C 0x00 0x66 0x00 0x7E 0x00 0x7C 0x00\n\t0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00\n\t0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00\n\t0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00\n\t0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00\n\t0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x80 0x00 0x80 0x00 0x80 0x00\n\t0x80 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00\n\t0x00 0x00 0x00 0x00 0x00 0x00 0x80 0x00 0x80 0x00 0x80 0x00 0x00 0x00 0x00 0x00\n\t0x00 0x00 0xCC 0x00 0xCC 0x00 0xFC 0x00 0x78 0x00 0x30 0x00 0x30 0x00 0x30 0x00\n\t0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00\n\t0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00\n\t0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00\n\t0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00\n\t0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00\n\t0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00\n\t0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00\n\t0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00\n\t0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00\n\t0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00\n\t0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00\n\t0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00\n\t0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00\n\t0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00\n\t0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00\n\t0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00\n\t0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00\n\t0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00\n\t0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00\n\n: victory-data\n\t0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00\n\t0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00\n\t0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00\n\t0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00\n\t0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00\n\t0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00\n\t0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00\n\t0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00\n\t0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00\n\t0x00 0x03 0x00 0x0C 0x00 0x30 0x00 0x40 0x01 0x80 0x02 0x0F 0x04 0x30 0x08 0x80\n\t0x11 0x00 0x10 0x00 0x22 0x00 0x20 0x00 0x20 0x00 0x23 0xF8 0x2D 0x84 0x32 0x02\n\t0x34 0x02 0x14 0x02 0x1D 0x06 0x06 0x18 0x00 0x60 0x01 0x80 0x06 0x03 0x08 0x0C\n\t0x10 0x10 0x10 0x00 0x20 0x40 0x20 0x80 0x20 0x80 0x20 0x80 0x11 0x00 0x11 0x00\n\t0x10 0x00 0x10 0x81 0x08 0x06 0x04 0x0A 0x02 0x14 0x01 0x93 0x00 0x7F 0x00 0x00\n\t0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00\n\t0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00\n\t0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x07 0xF8 0x38 0x07\n\t0xC0 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x80 0x00 0x78 0xC3 0x00 0xC3\n\t0x00 0xC3 0x00 0x63 0x00 0x63 0x00 0x67 0x00 0x66 0x00 0x36 0x00 0x36 0x00 0x36\n\t0x00 0x36 0x00 0x36 0x00 0x1E 0x00 0x1C 0x3C 0x0C 0xC0 0x00 0x00 0x00 0x00 0x00\n\t0x00 0x00 0x00 0x00 0x00 0x08 0x00 0x00 0x00 0x08 0x00 0x00 0x00 0x00 0x1E 0x00\n\t0x61 0xC0 0x80 0x20 0x00 0x21 0x00 0x22 0x40 0x44 0x40 0x84 0x81 0x08 0x02 0x00\n\t0x02 0x08 0x02 0x00 0x03 0x00 0x00 0xF8 0x00 0x07 0x00 0x00 0x00 0x00 0x00 0x00\n\t0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00\n\t0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x0F 0x00 0x30 0x00 0x40 0x00 0x80 0x00 0xC0\n\t0xC0 0x40 0x38 0xC0 0x07 0x80 0x00 0x00 0x00 0x00 0x07 0x00 0x0F 0x9E 0x6D 0xDE\n\t0x6C 0xCC 0x6C 0xCC 0x6C 0xCC 0x6C 0x0C 0x6C 0x0C 0x6C 0x0C 0x6C 0x0C 0x6C 0x0C\n\t0x6C 0xCC 0x6C 0xCC 0x6C 0xCC 0x6F 0xCC 0x67 0x8C 0x60 0x00 0x00 0x00 0x00 0x00\n\t0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x80 0x00 0x00 0x00 0x00 0x00 0x00\n\t0x40 0x00 0x80 0x0F 0x00 0x30 0x00 0x40 0x00 0x80 0x01 0x01 0x02 0x01 0x02 0x81\n\t0x06 0x42 0x05 0xC2 0x04 0x42 0x02 0x82 0xFF 0x01 0x00 0x00 0x00 0x00 0x00 0x00\n\t0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00\n\t0x00 0x00 0x00 0x00 0x7F 0xC0 0x98 0x3C 0x20 0x07 0x40 0x38 0x00 0x40 0x00 0x47\n\t0x00 0xB8 0x00 0xC0 0x00 0x80 0x00 0x00 0x00 0x00 0x39 0xE6 0x7D 0xF6 0xED 0xBB\n\t0xCD 0x9B 0xCD 0x99 0xCD 0x99 0xCD 0x99 0xCD 0xB9 0xCD 0xF1 0xCD 0xE1 0xCD 0xF1\n\t0xCD 0xB1 0xCD 0x99 0xED 0x99 0xFD 0x8D 0x79 0x8C 0x01 0x80 0x00 0x00 0x00 0x00\n\t0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x01 0x00 0x00 0x00 0x01 0x00 0x00 0x00 0x00\n\t0x00 0x00 0x81 0x00 0x42 0x00 0x44 0x00 0x84 0x03 0x08 0x0C 0x08 0x10 0x10 0x21\n\t0x10 0x42 0x10 0x44 0x00 0x88 0x00 0xA8 0xC0 0xEC 0x3F 0xC3 0x00 0x00 0x00 0x00\n\t0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00\n\t0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x80 0x00 0x00 0x00 0xF8 0x00\n\t0x07 0xC0 0x00 0x20 0x00 0x18 0x00 0x04 0x00 0x02 0x1B 0x3F 0x3B 0x41 0x33 0x3C\n\t0x63 0x02 0xE7 0x01 0xC6 0x00 0xC6 0x00 0x86 0x00 0x86 0x1E 0x8C 0x01 0x8C 0x00\n\t0x8C 0x00 0x8C 0x00 0x80 0x00 0x8C 0x00 0x8C 0x00 0x00 0x01 0x00 0x00 0x00 0x00\n\t0x00 0x00 0x00 0x01 0x00 0x00 0x40 0x00 0x80 0x00 0x40 0x01 0x00 0x02 0x00 0x03\n\t0x00 0x00 0x02 0x00 0x01 0x80 0x00 0x40 0x00 0x20 0x80 0x10 0x80 0x08 0x00 0x04\n\t0x00 0x02 0x00 0x02 0x00 0x01 0x00 0x01 0x00 0x00 0xF8 0x00 0x07 0x00 0x00 0xE0\n\t0x00 0x1C 0x00 0x02 0x00 0x01 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00\n\t0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00\n\t0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00\n\t0x00 0x00 0x80 0x00 0x40 0x00 0x20 0x00 0x10 0x00 0x10 0x00 0xC8 0x00 0x24 0x00\n\t0x04 0x00 0x02 0x00 0x02 0x00 0x01 0x00 0x3D 0x00 0xC7 0x00 0x61 0x00 0x18 0x00\n\t0x04 0x00 0x82 0x00 0x62 0x00 0x09 0x00 0x01 0x00 0xF1 0x00 0x09 0x00 0x05 0x00\n\t0x87 0x00 0x4B 0x00 0x26 0x00 0x10 0x00 0x10 0x00 0x10 0x00 0x08 0x00 0x08 0x00\n\t0x08 0x00 0x08 0x00 0x08 0x00 0x08 0x00 0x08 0x00 0x90 0x00 0x90 0x00 0x10 0x00\n\t0x50 0x00 0x10 0x00 0x20 0x00 0xA0 0x00 0xA0 0x00 0x40 0x00 0x40 0x00 0x00 0x00\n\t0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00\n\t0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00\n\t0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00\n\t0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00\n\t0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00\n\t0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00\n\t0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00\n\t0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00\n\nto-code\n\n# note: this routine expects i and plane to be\n# configured properly before a call:\n: screen-blit\n\tv0 := 0\n\tv1 := 0\n\tv2 := 16\n\tv3 := 32\n\tv4 := 48\n\tloop\n\t\tsprite v0 v1 0  i += v3\n\t\tsprite v0 v2 0  i += v3\n\t\tsprite v0 v3 0  i += v3\n\t\tsprite v0 v4 0  i += v3\n\t\tv0 += 16\n\t\tif v0 != 128 then\n\tagain\n;\n\n###########################################\n#\n#  Sound Effects\n#\n###########################################\n\nto-data\n\n# sound effects are stored as a 1-byte duration (1/60s of a second) followed by\n# 16 bytes of 4khz 1-bit waveform data.\n\n: sound-jump 1  0xE3 0x8E 0x38 0xE3 0x8E 0x38 0xC7 0x1C 0x71 0xC7 0x1C 0x71 0xCE 0x38 0xE3 0x8E\n: sound-step 1  0x02 0x21 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00\n: sound-land 1  0xA5 0xDF 0x71 0xDC 0x50 0x1D 0x38 0x97 0x5A 0x7D 0xDF 0xB5 0xE5 0xF4 0x97 0xD5\n: sound-hurt 4  0x02 0x21 0x00 0x08 0x66 0x00 0xD8 0x01 0xB0 0x20 0x10 0x10 0x00 0x00 0x00 0x00\n: sound-get  4  0xF8 0xF8 0xF8 0xF8 0xF8 0xF8 0xF8 0xF8 0xF8 0xF8 0xF8 0xF8 0xF8 0xF8 0xF8 0xF8\n\nto-code\n\n# this is the simplest way to use the XO-Chip audio pattern buffer:\n# brief, percussive patterns played in a set-and-forget manner.\n# see Octo's Audio Editor in the toolbox to preview and edit these sounds.\n\n: play-sound\n\tload stemp - stemp\n\tvf := 1\n\ti += vf\n\taudio\n\tbuzzer := stemp\n;\n\n:macro sfx SOUND {\n\ti := long SOUND\n\tplay-sound\n}\n\n###########################################\n#\n#  The Game Board\n#\n###########################################\n\n# these macros provide shorthands for building maps as well\n# as longer named constants for game logic for each tile:\n:macro tile-def NAME SYMBOL {\n\t:calc  NAME   { 8 * CALLS }\n\t:macro SYMBOL { :byte NAME }\n}\n:macro special-def NAME SYMBOL {\n\t:calc  NAME   { - 1 + CALLS }\n\t:macro SYMBOL { :byte NAME }\n}\n\nto-data\n\n# tiles are 8x4, in 2-bit color.\n# the second plane's color is exclusively used\n# for drawing the player and \"dangerous\" objects,\n# allowing us to use the vf register to probe for\n# pixel-perfect overlaps between dangerous objects\n# and the player.\n: tiles\n\t0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00  tile-def TILE_NONE      .\n\t0x7E 0x42 0x7E 0x42 0x00 0x00 0x00 0x00  tile-def TILE_LADDER    H\n\t0x00 0x00 0x00 0x00 0x00 0x22 0x66 0x66  tile-def TILE_SPIKE     ^\n\t0x00 0x00 0x00 0x00 0x66 0x66 0x22 0x00  tile-def TILE_DOWNSPIKE v\n\t0x7E 0x24 0x00 0x00 0x00 0x00 0x00 0x00  tile-def TILE_ONEWAY    $\n\t0xFF 0xFF 0xFF 0xFF 0x00 0x00 0x00 0x00  tile-def TILE_SOLID     @\n\t0xFF 0xF7 0x62 0x40 0x00 0x00 0x00 0x00  tile-def TILE_STELAC    V\n\t0xFF 0x00 0xFF 0xFF 0x00 0x00 0x00 0x00  tile-def TILE_TOP       -\n\t0x7F 0x80 0xBF 0xFF 0x00 0x00 0x00 0x00  tile-def TILE_TOP_L     /\n\t0xFE 0x01 0xFD 0xFF 0x00 0x00 0x00 0x00  tile-def TILE_TOP_R     \\\n\t0xFF 0x7E 0x81 0x00 0x00 0x00 0x00 0x00  tile-def TILE_PLAT      x\n\t0x77 0x55 0x77 0x00 0x00 0x00 0x00 0x00  tile-def TILE_BOX       o\n\t0x7F 0x41 0x41 0x41 0x00 0x00 0x00 0x00  tile-def TILE_BOX_TOP   k\n\t0x41 0x41 0x7F 0x00 0x00 0x00 0x00 0x00  tile-def TILE_BOX_BOT   l\n\nspecial-def TILE_PLAYER_L A\nspecial-def TILE_PLAYER_R B\nspecial-def TILE_PLAYER_D C\nspecial-def TILE_PLAYER_U D\nspecial-def TILE_BAT      b\nspecial-def TILE_LEAF     L\n\n# 16x16 tiles in 128x64 pixel hi-res mode\n: board\n\t0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0\n\t0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0\n\t0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0\n\t0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0\n\t0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0\n\t0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0\n\t0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0\n\t0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0\n\t0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0\n\t0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0\n\t0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0\n\t0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0\n\t0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0\n\t0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0\n\t0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0\n\t0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0\n\n# rooms are copied to the 'board' buffer before\n# drawing/gameplay, so that the board may be\n# modified in-place and later restored.\n# it also gives us an opportunity to normalize\n# \"special\" tiles into empty space and\n# reduces indirection during gameplay.\n\n: room-0\n\tV @ V . . . . . . . . . . . V V\n\t. V . . . . . . . . . . . . . .\n\t. . . . . . . . . . . . . . . .\n\t. . . . . . . . . . . . . . . .\n\t. . . . . . . . . . . . . . . .\n\t. . . . . . . . . . . . . . . .\n\t. . . . . . . . . . . . . . . .\n\t. . . . . . . . . . . . . . . .\n\t. . . . . . . . . C . . . . . .\n\t. . . . . . . . . . . . . . . .\n\t. . . . . . . . . . . . . . . .\n\tA . . . . . . . . . . . . . . B\n\t. . . . . . . . . . . . . . . .\n\t- - - - - - - - - - - - \\ . / -\n\t@ @ @ @ @ @ @ @ @ @ @ @ @ . @ @\n\t@ @ @ @ @ @ @ @ @ @ @ @ @ . @ @\n: room-1\n\t. . . . . . . . . . . . . . . @\n\t. . . . . . . . . . . . . . . @\n\t. . . . . . . . . . . C . . . @\n\t. . . . . . . . . . . . . . . @\n\t. . . . . . . . . . . $ . . . @\n\t. . . . . . . . . . . . . . . @\n\t. . . . . . . . . . . . . . . @\n\t. . . . . . . . . . . . . . . @\n\t. . . . . . . . . . . . . . . @\n\t. . . . . . . . . . . . $ $ . @\n\t. . . . . . . . . . . . . . . @\n\tA . . . . . . . . D . . . . . @\n\t. . . / \\ . . . . . . . . . . @\n\t- - . @ @ - - - - \\ . . . . ^ @\n\t@ @ ^ @ @ @ @ @ @ @ . . . . @ @\n\t@ @ @ @ @ @ @ @ @ @ . . . . . @\n: room-2\n\t. . . . . . . . . . . . . . . .\n\t. . . . . . . . . . . . . . . .\n\t. . . . . . . . . . . . . . . .\n\t. . . . . . . . . . . . . . . .\n\t. . . . . . . . . . . . . . . .\n\t. . . . . . . . . . . . . . . .\n\tA . . . . . . . . . . . . . . .\n\t. . . . . . . . . . . . . . . .\n\t- - - \\ . . . . . . . . . . . .\n\t@ @ @ @ . . . . . . . . . . . .\n\t@ @ @ @ . . . . . . . . . . . .\n\t@ @ @ @ - - - \\ . . . . . . . B\n\t@ @ @ @ @ @ @ @ . . . . . . . .\n\t@ @ @ @ @ @ @ @ - - - - - - - -\n\t@ @ @ @ @ @ @ @ @ @ @ @ @ @ @ @\n\t@ @ @ @ @ @ @ @ @ @ @ @ @ @ @ @\n: room-3\n\t@ @ @ @ @ @ @ @ @ @ @ @ @ C @ @\n\t@ @ @ @ @ @ @ @ @ @ @ @ V . V @\n\t. . . V V . . . V . . V . . . V\n\t. . . . . . . . . . . . . . . .\n\t. . . . . . . . . . . . . . . .\n\t. . . . . . . . b . . . . . . .\n\t. . . . . . . . . . . . . . . .\n\t. . . . . . . . . . . . . . . .\n\t. . . . . . . . . . . . . . . .\n\t. . . . . . . . . . . . . . . .\n\tA . . . . . . . . . . . . . . B\n\t. . . . . . . . . . . . . . . .\n\to o o o . k k o o . . . . . k k\n\to k o o o l l o o o k o o o l l\n\to l o o o o o o o o l o o o o o\n\to o o k o o o o o o o o k o o o\n: room-4\n\t@ @ @ @ @ @ @ @ @ @ . . . C . @\n\t@ @ @ @ @ @ @ @ @ @ . . . . . @\n\t. . . V V . V @ @ V . . . . . @\n\t. . . . . . . V V . . . . . . @\n\t. . . . . . . . . . . . . . . @\n\t. . . . . . . . L . . . . . . @\n\t. . . . . . . . . . . . . ^ ^ @\n\t. . . . . . . . o o . . . @ @ @\n\t. . o . . . . . k o . . . V @ @\n\t. . . . . . . . l k . . . . . .\n\tA . . . . . . . o l . . . . . B\n\t. . . . . . . . o o . . . . . .\n\tk k o o o . . . o o . . . k k k\n\tl l o k k . . . k o . . . l l l\n\t. . o l l . . . l o . . . k k k\n\t. . o o o . . . . . . . . l l l\n: room-5\n\t@ @ @ @ @ @ @ @ @ @ @ @ @ @ @ @\n\t@ @ @ @ V V . . . . . . V @ @ @\n\t@ @ @ V . . . . . . L . . @ @ o\n\t@ o @ . . . . . . . . . . @ o o\n\t@ o @ . . . / - - - \\ . . @ @ @\n\t@ @ @ . . . @ @ @ @ @ . . @ @ @\n\t@ @ o . . / @ @ @ @ @ . . @ @ @\n\to o o . . @ . . v v v . . o @ @\n\to o o $ $ V . . . . . . . o o o\n\t. . . . . . . . . . . . . o o o\n\tA . . . . . . . . . . . . k k k\n\t. . . . . . . . . . . . . l l l\n\tk k k k k . . k k k k . . k k k\n\tl l l l l ^ ^ l l l l ^ ^ l l l\n\t. . k k k k k k k k k k k k k k\n\t. . l l l l l l l l l l l l l l\n: room-6\n\to o o o o . . . . . . . . o l l\n\to o o k k . . . . . . . C o o l\n\to k k l l . . . . . . . . o k k\n\to l l o o . . . . . . . . o l l\n\tk k o . o . . . . . . . . . o o\n\tl l . . . . . . . . . . . . k k\n\tk k . . . . . . . . . . . . l l\n\tl l . . . . . . . . . . . . k k\n\tk . . . . . . . . . . . . . l l\n\tl . . . . . . . . . . . . . k k\n\tA . . . . . . . . . . . . . l l\n\t. . . . . . . . . . . . o o o o\n\tk k . . . . k k . . . . k k k k\n\tl l ^ ^ ^ ^ l l ^ ^ ^ ^ l l l l\n\tk k k k k k k k k k k k k k k k\n\tl l l l l l l l l l l l l l l l\n: room-7\n\tk k k k k k k k o o o o o o k k\n\tl l l l l l l l v v v v v v l l\n\tA . . . . . . . . . . . L . k k\n\t. . . . . . . . . . . . . . l l\n\to o o o o o o o . . o o . o k k\n\to o v v v v v v . . v v . v l l\n\tk k . . . . . . . . . . . . k k\n\tl l . . . . . . . . . . . . l l\n\tk k o . . o o o o o o o o o k k\n\tl l v . . v v v v v v v v v l l\n\tk k . . . . . . . . . . . . . B\n\tl l . . . . . . . . . . . . . .\n\tk k k k k k k k k k k k k k k k\n\tl l l l l l l l l l l l l l l l\n\t. . k k k k k k k k k k k k k k\n\t. . l l l l l l l l l l l l l l\n: room-8\n\tk k k k k k k k k k k . . k k k\n\tl l l l l l l l l l l . . l l l\n\tk k . . . . . . . . . . . . . B\n\tl l . . . . . . . . . . . . . .\n\tk k . . . . . . . . k k k k k k\n\tl l . . . . . . . . l l l l l l\n\to o . . . . . . . . k o o o o o\n\to o ^ ^ . ^ ^ . $ . l o o o o o\n\to o o o L o o . . . k o o o o o\n\to o o o . o o . . . l o o o o o\n\to o . o . o . . . . k o o o o o\n\to o . . . . . . $ . l o o o o o\n\to k . . . . . . . . k o o o o o\n\to l . . . . . . . . l o o o o o\n\t@ @ ^ ^ ^ . . . o o o o o o o o\n\t@ @ o o o o o o o o o o o o o o\n: room-9\n\t@ @ @ @ @ @ @ @ @ @ @ @ @ @ @ @\n\t@ @ @ @ @ @ @ @ @ @ @ @ @ @ @ @\n\t. . . . . V . . . . . . V . . .\n\t. . . . . . . . . . . . . . . .\n\t. . . L . . . . . . . . . . . .\n\t. . . . . . . . . . . . . . . b\n\t. . . $ . . . . . . . . . . . .\n\t. . . . . . . . . . . . . . . .\n\t. . . . . $ . . . . . . . . . .\n\t. . . . . . . . . . . . . . . .\n\tA . . . . . . . . . . . . . . B\n\t. . . . . . . . . . o $ $ o . .\n\to k o . . . o o o k o . D o o o\n\to l o ^ ^ ^ o o o l o . . o o o\n\t@ @ o o k o k o o o o $ $ o o o\n\t@ @ o o l o l o o o o . . o o o\n: room-10\n\t@ @ @ @ @ @ @ @ @ @ @ . . @ @ @\n\t@ @ @ @ @ @ @ @ @ @ @ . . V @ @\n\t@ @ V . . . . . . . V . . . V .\n\tk V . . . . . . . . . $ $ . . .\n\tl . . . . . . . . . . . . . . .\n\to . . . . / - - - \\ . . . . . .\n\tk . L . . @ @ @ @ @ . $ $ . . .\n\tl . . . . @ V . . . . . . . . b\n\tk . . . . @ . . . . . . . . . .\n\tl . . . . . . . . . . $ $ . . .\n\to ^ . . . . . . . . . . . . . B\n\tk o ^ . . . . . . . . . . . . .\n\tl k k ^ o o o o o o o o o o o k\n\to l l o o o o o o o o o k o k l\n\t@ @ o o o o o o k o o o l o l o\n\t@ @ o o o o o o l o o o o o o o\n: room-11\n\t@ @ V . . . . . V @ V V . . . .\n\t@ V . . . . . . . V . . . . . .\n\t@ . . . . . . . . . . . . . . b\n\t@ . . . . . . . . . . . . . . .\n\t@ . . . . . . . . . . . . . . .\n\t@ . . . . . . . . . . . . . . .\n\t@ . . . . . . . . . . / \\ . . B\n\t@ . . . . . . / \\ . / @ @ . . .\n\t@ . . . / - - @ @ - @ @ @ - - -\n\t@ . . . @ @ @ @ @ @ @ @ @ @ @ @\n\t@ . . . . . . . . . . . V @ @ @\n\t@ . . . . . . . . . . . . @ @ @\n\t@ \\ . . . . . . . . . . . @ @ @\n\t@ @ - - - - - - - - \\ . D @ @ @\n\t@ @ @ @ @ @ @ @ @ @ @ . . @ @ @\n\t@ @ @ @ @ @ @ @ @ @ @ $ $ @ @ @\n: room-12\n\t. . . . . . . . . . . V @ @ @ @\n\t. . . . . . . . . . . . V V @ @\n\t. . . . . . . . . . . . . . V @\n\t. . . . . . . . . . . . . . . @\n\t. . . . . . . . . L . . . . . @\n\t. . . . . . . . . . . . . . . @\n\t\\ . . . . . . . / \\ . . . . . @\n\t@ . $ $ . . . . @ @ . . . . . @\n\tV . . . . . . . v v . . . . . @\n\t. . . . . . . . . . . . . . . @\n\t. . . . . . . . . . . . . . . @\n\t. . . . . . . . . . . . . . . @\n\t. . . . . $ $ . . . . . . . . @\n\t. . . . . . . . . . . D . . . @\n\t. . . . . . . . . . . . . . . @\n\t. . . . . . . . . . . $ . . . @\n: room-13\n\t@ @ V . . . . . . . . . . . . .\n\t@ @ . . . . . . . . . . . . . .\n\t@ @ . . . . . . . . . . . . . .\n\t@ @ . . . . . . . . . . . . . .\n\t@ @ . . . . . . . . . . . . . B\n\t@ @ . . . . . . . . . . . . . .\n\t@ @ . . . . . . . . . . / - - -\n\t@ V . . L . . . . . . . @ @ @ @\n\t@ . . . . . . . . . . . V V @ V\n\t@ . . . $ . . . $ . . . . . V .\n\t@ . . . . . . . . . . . . . . .\n\t@ . . . . . . . . . . . . . . .\n\t@ ^ . . . ^ ^ ^ . . . . . . . .\n\t@ @ . . . V @ V . . . . . . . .\n\t@ @ ^ . . . V . . . . . . . . ^\n\t@ @ @ . . . . . . . . . . . ^ @\n\n: rooms\n\tpointer room-0\n\tpointer room-1\n\tpointer room-2\n\tpointer room-3\n\tpointer room-4\n\tpointer room-5\n\tpointer room-6\n\tpointer room-7\n\tpointer room-8\n\tpointer room-9\n\tpointer room-10\n\tpointer room-11\n\tpointer room-12\n\tpointer room-13\n\n# for reference, here's how all the current rooms\n# are laid out spatially:\n#\n#        13 12\n#   11 2  0  1\n#   10 9  3  4  5\n#      8  7  6\n#\n\n: adjacency\n\t# the index of the room in direction { LEFT, RIGHT, UP, DOWN }\n\t# or -1 to indicate no room in that direction:\n\t 2   1  13   3 # 0  (start)\n\t 0  -1  12   4 # 1\n\t11   0  -1  -1 # 2\n\t 9   4   0  -1 # 3\n\t 3   5   1   6 # 4  (leaf)\n\t 4  -1  -1  -1 # 5  (leaf)\n\t 7  -1   4  -1 # 6\n\t 8   6  -1  -1 # 7  (leaf)\n\t-1   7   9  -1 # 8  (leaf)\n\t10   3  -1   8 # 9  (leaf)\n\t-1   9  11  -1 # 10 (leaf)\n\t-1   2  -1  10 # 11\n\t13  -1  -1   1 # 12 (leaf)\n\t-1  12  -1   0 # 13 (leaf)\n\nto-code\n\n# do this first, in its own pass, so that\n# we can hide the time it takes and speed up drawing:\n: board-unpack\n\tbat-clear\n\tleaf-clear\n\ti := player-room\n\tload v0\n\ti := long rooms\n\ti += v0\n\ti += v0\n\tload v1\n\ti := room-source\n\tsave v1\n\n\tv1 := 0 # x\n\tv2 := 0 # y\n\tv3 := 0 # index\n\tloop\n\t\tindirect room-source\n\t\ti += v3\n\t\tload v0\n\t\t:macro player-spawner TILE {\n\t\t\tif v0 == TILE begin\n\t\t\t\t:calc dest { room-spawns + CALLS * 2 }\n\t\t\t\ti := dest\n\t\t\t\tsave v1 - v2\n\t\t\t\tv0 := TILE_NONE\n\t\t\tend\n\t\t}\n\t\tplayer-spawner TILE_PLAYER_R\n\t\tplayer-spawner TILE_PLAYER_L\n\t\tplayer-spawner TILE_PLAYER_U\n\t\tplayer-spawner TILE_PLAYER_D\n\t\tif v0 == TILE_BAT begin\n\t\t\tbat-init\n\t\t\tv0 := TILE_NONE\n\t\tend\n\t\tif v0 == TILE_LEAF begin\n\t\t\tleaf-init\n\t\t\tv0 := TILE_NONE\n\t\tend\n\n\t\ti := long board\n\t\ti += v3\n\t\tsave v0\n\n\t\tv1 += 8\n\t\tif v1 == 128 then v2 += 4\n\t\tif v1 == 128 then v1 := 0\n\t\tv3 += 1\n\t\tif v3 != 0 then\n\tagain\n;\n\n# in principle this routine could be unrolled\n# for speed, but it is not observably the limiting\n# factor in the game engine:\n: board-draw\n\tplane 3\n\tv1 := 0 # x\n\tv2 := 0 # y\n\tv3 := 0 # index\n\tloop\n\t\ti := long board\n\t\ti += v3\n\t\tload v0\n\t\ti := long tiles\n\t\ti += v0\n\t\tsprite v1 v2 4\n\n\t\tv1 += 8\n\t\tif v1 == 128 then v2 += 4\n\t\tif v1 == 128 then v1 := 0\n\t\tv3 += 1\n\t\tif v3 != 0 then\n\tagain\n\tbat-draw\n\tleaf-draw\n\n\ti := player-room\n\tload v0\n\tif v0 == 0 begin\n\t\tplane 1\n\t\ti := long title-data\n\t\tscreen-blit\n\tend\n;\n\n###########################################\n#\n#  The Player\n#\n###########################################\n\n:const PLAYER_HEIGHT 8\n:calc  FACE_LEFT { PLAYER_HEIGHT * 7 }\n:macro frame-def NAME {\n\t:calc NAME { PLAYER_HEIGHT * CALLS }\n}\n\nto-data\n\n: player-frames\n\t0x00 0x3C 0x28 0x3C 0x7E 0x7E 0x3C 0x24  frame-def FRAME_STAND\n\t0x00 0x3C 0x28 0x3C 0xFC 0x3C 0x3C 0x24  frame-def FRAME_RUN_0\n\t0x3C 0x28 0x3C 0xFC 0x3C 0x3C 0x28 0x08  frame-def FRAME_RUN_1\n\t0x00 0x3C 0x28 0x3C 0xFC 0x3C 0x3C 0x18  frame-def FRAME_RUN_2\n\t0x3C 0x28 0x3C 0xFC 0x3C 0x3C 0x18 0x10  frame-def FRAME_RUN_3\n\t0x3C 0x28 0x3C 0x3C 0x7E 0x3C 0x28 0x00  frame-def FRAME_JUMP\n\t0x00 0x3C 0xA9 0x7E 0x3C 0x3C 0x3C 0x24  frame-def FRAME_FALL\n: player-frames-mirrored\n\tmirror-frame FRAME_STAND\n\tmirror-frame FRAME_RUN_0\n\tmirror-frame FRAME_RUN_1\n\tmirror-frame FRAME_RUN_2\n\tmirror-frame FRAME_RUN_3\n\tmirror-frame FRAME_JUMP\n\tmirror-frame FRAME_FALL\n\n: player-dead\n\t0x00 0x3C 0x89 0x7E 0x3C 0x3C 0x3C 0x42\n: dust-animation\n\t0x00 0x00 0x00 0x00 0x00 0x00 0x18 0x00\n\t0x00 0x00 0x00 0x00 0x00 0x38 0x66 0x18\n\t0x00 0x00 0x00 0x00 0x00 0x38 0x66 0x18\n\t0x00 0x00 0x00 0x00 0x00 0x00 0x18 0x00\n:calc DUST_END { 4 * 8 }\n\n# the player's vertical trajectory following a jump is controlled\n# through this lookup table, which is a series of y deltas.\n# when the player steps off a ledge, they immediately skip to\n# the downward part of the arc. Upon reaching the end of the table,\n# the player will maintain downward motion at TERMINAL_VELOCITY\n# until they collide with a floor surface:\n: player-arc      -3 -3 -3 -2 -2 -1 -1 -1 0\n: player-arc-down 1 1 1 2 2 3\n:const TERMINAL_VELOCITY 3\n:byte  TERMINAL_VELOCITY\n:calc  ARC_LENGTH { -1 + HERE       - player-arc }\n:calc  ARC_TOP    { player-arc-down - player-arc }\n\n# when a player steps off a ledge, they have a few frames during\n# which they are still permitted to initiate a jump, known as\n# \"coyote time\" in reference to Looney Tunes:\n:calc  COYOTE_GRACE_PERIOD { ARC_TOP + 2 }\n\nto-code\n\n: player-spawn\n\tpx_sign := 0\n\tdx      := 0\n\tflags   := 0\n\tframe   := 0\n\n\ti := player-entrance\n\tload v0\n\tif v0 == ENTER_RIGHT begin\n\t\tset-flag FLAG_LEFT\n\tend\n\ti := room-spawns\n\ti += v0\n\ti += v0\n\tload px - py\n;\n\n: player-init\n\t# like player-draw, but for the first frame only; no erasing!\n\tplane 2\n\ti := long player-frames\n\tsprite px py PLAYER_HEIGHT\n\n\t# initialize the previous frame buffer:\n\ti  := player-prev\n\tv0 := 0\n\tv1 := px\n\tv2 := py\n\tsave v2\n\n\ti  := player-dust\n\tv0 := DUST_END\n\tsave v0\n;\n\n:macro player-poll-release {\n\tif-flag FLAG_PRESSED begin\n\t\tvf := OCTO_KEY_E\n\t\tif vf -key begin\n\t\t\tclear-flag FLAG_PRESSED\n\t\tend\n\tend\n}\n\n# The player-test routines are the basis for all\n# player-map collision. Since this happens very frequently,\n# these two chunks of the board indexing process have been\n# factored into subroutines:\n: player-test-a\n\tv1 += px\n\tclamp v1 -16 1  128 127\n\tv1 >>= v1 # / 2\n\tv1 >>= v1 # / 4\n\tv1 >>= v1 # / 8\n\ti := long board\n\ti += v1\n;\n: player-test-b\n\tv1 += py # /4, *16 ...\n\tclamp v1 -16 1  64 63\n\tv2 := 0b11111100\n\tv1 &= v2\n\tv1 <<= v1\n\tv1 <<= v1\n\ti += v1\n\tload v1 - v1\n;\n# probe the map at an offset from the player location (in pixels),\n# and return the TILE_XXX value at that location:\n:macro player-test XOFF YOFF {\n\tv1 := XOFF\n\tplayer-test-a\n\tv1 := YOFF\n\tplayer-test-b\n}\n:macro solid-test XOFF YOFF { # OR a result into v4\n\tplayer-test XOFF YOFF\n\tif v1 >= TILE_SOLID then v4 := 1\n}\n:macro floor-test XOFF YOFF { # OR a result into v4\n\tplayer-test XOFF YOFF\n\tif v1 >= TILE_ONEWAY then v4 := 1\n}\n\n# the player bounding box proper is factored out into macros here\n# so that it can be viewed/edited together more easily.\n# users of these routines must clear v4 before invocation:\n:macro bounding-box-l {\n\tsolid-test  0 0\n\tsolid-test  0 7\n}\n:macro bounding-box-r {\n\tsolid-test  7 0\n\tsolid-test  7 7\n}\n:macro bounding-box-u {\n\tsolid-test  2 -1\n\tsolid-test  6 -1\n}\n:macro bounding-box-d {\n\t# the special treatment of the \"down\" boundaries\n\t# is for \"one-way\" platforms, which are only\n\t# solid when the player is moving downward:\n\tfloor-test  2 PLAYER_HEIGHT\n\tfloor-test  6 PLAYER_HEIGHT\n}\n:macro bounding-box-eject {\n\t# additionally, if we slip into one-way platforms\n\t# horizontally, we may need to push the player\n\t# up to the top of the platform:\n\tv0 := 0\n\tplayer-test 2 7\n\tif v1 == TILE_ONEWAY then v0 := 1\n\tplayer-test 6 7\n\tif v1 == TILE_ONEWAY then v0 := 1\n\tif v0 != 0 then py += -1\n}\n\n:macro player-horizontal {\n\t:macro horizontal-movement KEY DELTA LEFT BOUNDS {\n\t\tvf := KEY if vf key begin\n\t\t\tdx := 4\n\t\t\tif-flag FLAG_JUMPED then dx := 2\n\t\t\tpx_sign := DELTA\n\t\t\tLEFT FLAG_LEFT\n\t\tend\n\t\tif px_sign == DELTA begin\n\t\t\t# always probe the bounding box while\n\t\t\t# adding a single pixel to position at a time;\n\t\t\t# this ensures we don't penetrate walls:\n\t\t\tv0 := 0\n\t\t\tloop\n\t\t\t\tv4 := 0\n\t\t\t\tBOUNDS\n\t\t\t\tif v4 != 0 begin\n\t\t\t\t\tpx_sign := 0\n\t\t\t\t\tdx := 0\n\t\t\t\t\tv0 := dx\n\t\t\t\tend\n\t\t\t\twhile v0 != dx\n\t\t\t\tv0 += 1\n\t\t\t\tpx += DELTA\n\t\t\tagain\n\t\tend\n\t}\n\thorizontal-movement OCTO_KEY_A -1 set-flag   bounding-box-l\n\thorizontal-movement OCTO_KEY_D  1 clear-flag bounding-box-r\n\tif-flag FLAG_LEFT then v3 += FACE_LEFT\n}\n\n:macro player-do-jump {\n\t:calc JUMP_AND_PRESSED { FLAG_JUMPED | FLAG_PRESSED }\n\tset-flag JUMP_AND_PRESSED\n\tframe := 0\n\tpy += -1\n\n\ti  := player-dust\n\tv0 := 0\n\tv1 := px\n\tv2 := py\n\tsave v2\n\n\tsfx sound-jump\n}\n\n:macro player-jumping {\n\t# jump in a grace period after ledge-falling?\n\tvf := OCTO_KEY_E if vf key begin\n\t\tif frame <= COYOTE_GRACE_PERIOD begin\n\t\t\tif-flag FLAG_FELL begin\n\t\t\t\tif-not-flag FLAG_PRESSED begin\n\t\t\t\t\tclear-flag FLAG_FELL\n\t\t\t\t\tplayer-do-jump\n\t\t\t\tend\n\t\t\tend\n\t\tend\n\tend\n\ti := long player-arc\n\ti += frame\n\tload v0\n\tvf := 0b1000000\n\tvf &= v0\n\tif vf != 0 begin\n\t\t# moving up; collide with roof?\n\t\t# as before, probe iteratively and move in\n\t\t# single-pixel steps:\n\t\tloop\n\t\t\tv4 := 0\n\t\t\tbounding-box-u\n\t\t\tif v4 != 0 begin\n\t\t\t\t# hit ceiling!\n\t\t\t\tframe := ARC_TOP\n\t\t\t\tv0 := 0\n\t\t\tend\n\t\t\twhile v0 != 0\n\t\t\tpy += -1\n\t\t\tv0 += 1\n\t\tagain\n\t\tv3 += FRAME_JUMP\n\telse\n\t\tif v0 != 0 begin\n\t\t\t# moving down; collide with floor?\n\t\t\tloop\n\t\t\t\tv4 := 0\n\t\t\t\tbounding-box-d\n\t\t\t\tif v4 != 0 begin\n\t\t\t\t\t# hit the ground?\n\t\t\t\t\t:calc GROUND_RESET { FLAG_JUMPED | FLAG_FELL }\n\t\t\t\t\tclear-flag GROUND_RESET\n\t\t\t\t\tv0 := 0\n\t\t\t\t\tsfx sound-land\n\t\t\t\tend\n\t\t\t\twhile v0 != 0\n\t\t\t\tpy += 1\n\t\t\t\tv0 += -1\n\t\t\tagain\n\t\t\tv3 += FRAME_FALL\n\t\tend\n\tend\n\tif frame != ARC_LENGTH then frame += 1\n}\n\n:macro player-walking {\n\t# allow the player to jump\n\tvf := OCTO_KEY_E if vf key begin\n\t\tif-not-flag FLAG_PRESSED begin\n\t\t\tplayer-do-jump\n\t\telse\n\t\t\tjump normal-walking\n\t\tend\n\telse\n\t\t: normal-walking\n\t\t# friction applies while on the ground\n\t\tif dx != 0 then dx += -1\n\t\tif dx == 0 then px_sign := 0\n\n\t\t# ground animation\n\t\tif px_sign == 0 begin\n\t\t\t# standing still\n\t\t\tframe := 0\n\t\t\tbounding-box-eject\n\t\telse\n\t\t\t# walking\n\t\t\tvf := 0b11\n\t\t\tvf &= frame\n\t\t\tif vf == 1 begin\n\t\t\t\tsfx sound-step\n\t\t\tend\n\n\t\t\tv3 += FRAME_RUN_0\n\t\t\tframe += 1\n\t\t\tv0 := frame\n\t\t\tvf := 0b110\n\t\t\tv0 &= vf\n\t\t\tv0 <<= v0 # *4\n\t\t\tv0 <<= v0 # *8\n\t\t\tv3 += v0\n\t\tend\n\t\t# fall off ledges:\n\t\tv4 := 0\n\t\tbounding-box-d\n\t\tif v4 == 0 begin\n\t\t\t:calc COYOTE_TIME { FLAG_JUMPED | FLAG_FELL }\n\t\t\tset-flag COYOTE_TIME\n\t\t\tframe := ARC_TOP\n\t\tend\n\tend\n}\n\n:macro player-die {\n\t# erase current player\n\ti := long player-frames\n\ti += v3\n\tsprite px py PLAYER_HEIGHT\n\tplane 1\n\n\t# erase dust, if any:\n\ti := player-dust\n\tload v2\n\tloop\n\t\twhile v0 != DUST_END\n\t\ti := long dust-animation\n\t\ti += v0\n\t\tv0 += 8\n\t\tsprite v1 v2 8\n\tagain\n\n\t# record the death\n\ti := total-deaths\n\tload v0 - v0\n\tif v0 != 99 then v0 += 1\n\tsave v0 - v0\n\n\t# draw dead player\n\tsfx sound-hurt\n\ti := long player-dead\n\tsprite px py PLAYER_HEIGHT\n\twait 30\n\tsprite px py PLAYER_HEIGHT\n\n\t# flicker on respawn\n\tplayer-spawn\n\tplane 2\n\ti := long player-frames\n\tif-flag FLAG_LEFT then i := long player-frames-mirrored\n\tv0 := 8\n\tloop\n\t\tsprite px py PLAYER_HEIGHT\n\t\twait 3\n\t\tv0 += -1\n\t\tif v0 != 0 then\n\tagain\n\n\tplayer-init\n\tjump main-body\n}\n\n:macro board-edges {\n\t:macro edge REGISTER MIN MAX ENTRANCE TARGET {\n\t\tif REGISTER > MIN begin\n\t\t\tif REGISTER < MAX begin\n\t\t\t\ti := player-room\n\t\t\t\tload v2 - v2\n\t\t\t\t:calc adjacent-room { adjacency + ENTRANCE }\n\t\t\t\ti  := long adjacent-room\n\t\t\t\ti  += v2\n\t\t\t\ti  += v2\n\t\t\t\ti  += v2\n\t\t\t\ti  += v2\n\t\t\t\tload v0\n\t\t\t\tif v0 != -1 begin\n\t\t\t\t\ti := player-room\n\t\t\t\t\tv1 := ENTRANCE\n\t\t\t\t\tsave v1\n\n\t\t\t\t\tboard-unpack\n\t\t\t\t\tplane 3\n\t\t\t\t\tclear\n\t\t\t\t\tboard-draw\n\n\t\t\t\t\tREGISTER := TARGET\n\t\t\t\t\tplayer-init\n\t\t\t\tend\n\t\t\tend\n\t\tend\n\t}\n\t:const EDGE_MARGIN 16\n\n\t:calc EDGE_LEFT_MIN { 0xFF & 0 - EDGE_MARGIN }\n\t:calc EDGE_LEFT_MAX { 0xFF & -1 }\n\tedge px EDGE_LEFT_MIN EDGE_LEFT_MAX ENTER_RIGHT 120\n\n\t:calc EDGE_RIGHT_MIN { 0xFF & 128 }\n\t:calc EDGE_RIGHT_MAX { 0xFF & 128 + EDGE_MARGIN }\n\tedge px EDGE_RIGHT_MIN EDGE_RIGHT_MAX ENTER_LEFT 0\n\n\t:calc EDGE_TOP_MIN { 0xFF & 0 - EDGE_MARGIN }\n\t:calc EDGE_TOP_MAX { 0xFF & -1 }\n\tedge py EDGE_TOP_MIN EDGE_TOP_MAX ENTER_UP 56\n\n\t:calc EDGE_BOTTOM_MIN { 0xFF & 61 }\n\t:calc EDGE_BOTTOM_MAX { 0xFF & 61 + EDGE_MARGIN }\n\tedge py EDGE_BOTTOM_MIN EDGE_BOTTOM_MAX ENTER_DOWN 0\n}\n\n:macro player-update {\n\t# the final player frame offset will reside in v3:\n\tv3 := 0\n\n\tplayer-poll-release\n\tplayer-horizontal\n\n\tif-flag FLAG_JUMPED begin\n\t\tplayer-jumping\n\telse\n\t\tplayer-walking\n\tend\n\n\t# erase previous\n\tplane 2\n\ti := player-prev\n\tload v2\n\n\t# player must be clipped at edges of the\n\t# display for at least one frame,\n\t# so that room transitions will work correctly:\n\tif v1 < 128 begin\n\t\tif v2 < 64 begin\n\t\t\ti := long player-frames\n\t\t\ti += v0\n\t\t\tsprite v1 v2 PLAYER_HEIGHT\n\t\tend\n\tend\n\t# draw new frame\n\tif px < 128 begin\n\t\tif py < 64 begin\n\t\t\ti := long player-frames\n\t\t\ti += v3\n\t\t\tsprite px py PLAYER_HEIGHT\n\n\t\t\t# player overlapped the DANGER color.\n\t\t\t# this might be a special item (leaves, exit portal),\n\t\t\t# but otherwise it's a hazard that will\n\t\t\t# kill the player:\n\t\t\tif vf != 0 begin\n\t\t\t\ti := player-room\n\t\t\t\tload v0\n\t\t\t\tif v0 == 0 begin\n\t\t\t\t\t# the portal is the only thing on\n\t\t\t\t\t# the start screen with the danger color:\n\t\t\t\t\tportal-touch\n\t\t\t\tend\n\t\t\t\tleaf-exists\n\t\t\t\tif v0 != -1 begin\n\t\t\t\t\tleaf-draw\n\t\t\t\t\tleaf-draw\n\t\t\t\t\tif vf != 0 begin\n\t\t\t\t\t\tleaf-get\n\t\t\t\t\t\tjump no-consequences\n\t\t\t\t\tend\n\t\t\t\tend\n\t\t\t\tplayer-die\n\t\t\tend\n\t\t\t: no-consequences\n\t\tend\n\tend\n\n\t# stash the new frame's config for erasing later:\n\ti  := player-prev\n\tv0 := v3\n\tv1 := px\n\tv2 := py\n\tsave v2\n\n\t# dust?\n\tplane 1\n\ti := player-dust\n\tload v2\n\tif v0 != DUST_END begin\n\t\ti := long dust-animation\n\t\ti += v0\n\t\tsprite v1 v2 8\n\t\tv0 += 8\n\t\ti := player-dust\n\t\tsave v2\n\tend\n}\n\n###########################################\n#\n#  Title Screen / End Sequence\n#\n###########################################\n\nto-data\n\n: twinkle\n\t0x00 0x00 0x28 0x10 0x28 0x00 0x00 0x00\n\t0x00 0x10 0x10 0x6C 0x10 0x10 0x00 0x00\n\t0xC6 0xAA 0x6C 0x00 0x6C 0xAA 0xC6 0x00\n\t0x00 0x10 0x10 0x6C 0x10 0x10 0x00 0x00\n\t0x00 0x00 0x28 0x10 0x28 0x00 0x00 0x00\n\n: portal\n\t0x00 0x00 0x00 0x10 0x00 0x00 0x00 0x00\n\t0x00 0x00 0x10 0x28 0x10 0x00 0x00 0x00\n\t0x00 0x38 0x44 0x54 0x44 0x38 0x00 0x00\n\t0x38 0x44 0x92 0xAA 0x92 0x44 0x38 0x00\n\t0x38 0x44 0x92 0xAA 0x92 0x44 0x38 0x00\n\t0x00 0x38 0x44 0x54 0x44 0x38 0x00 0x00\n\t0x00 0x00 0x10 0x28 0x10 0x00 0x00 0x00\n\t0x00 0x00 0x00 0x10 0x00 0x00 0x00 0x00\n\n: twinkle-pos\n\t42  3\n\t82 25\n\t35 39\n\nto-code\n\n:macro title-sequence {\n\tplane 1\n\tv3 := 0\n\tloop\n\t\tv0 := 20\n\t\tloop\n\t\t\tvf := OCTO_KEY_E\n\t\t\tif vf key then jump title-sequence-drop\n\t\t\tvf := OCTO_KEY_D\n\t\t\tif vf key then jump title-sequence-drop\n\t\t\tvf := OCTO_KEY_A\n\t\t\tif vf key then jump title-sequence-drop\n\t\t\tsync 3\n\t\t\tv0 += -1\n\t\t\tif v0 != 0 then\n\t\tagain\n\t\ti := long twinkle-pos\n\t\ti += v3\n\t\tload v1\n\t\tv2 := 0\n\t\tloop\n\t\t\ti := long twinkle\n\t\t\ti += v2\n\t\t\tsprite v0 v1 8\n\t\t\twait 3\n\t\t\tsprite v0 v1 8\n\t\t\tv2 += 8\n\t\t\t:calc TWINKLE_END { 5 * 8 }\n\t\t\tif v2 != TWINKLE_END then\n\t\tagain\n\t\tv3 += 2\n\t\tif v3 == 6 then v3 := 0\n\tagain\n\t: title-sequence-drop\n}\n\n:macro portal-animate {\n\ti := player-room\n\tload v0\n\tif v0 == 0 begin\n\t\ti := leaf-count\n\t\tload v0\n\t\tif v0 == LEAF_COUNT begin\n\t\t\tplane 2\n\t\t\ti := long portal\n\t\t\tv0 := 0b1110\n\t\t\tv0 &= time\n\t\t\tv0 <<= v0\n\t\t\tv0 <<= v0\n\t\t\ti += v0\n\t\t\tv0 := 72\n\t\t\tv1 := 33\n\t\t\tsprite v0 v1 8\n\t\tend\n\tend\n}\n\n: bcd-buffer 0    # hundreds\n: bcd-digits 0 0  # tens, ones\n\n: bcd-byte # decode v0, at v2/v3...\n\ti := bcd-buffer\n\tbcd v0\n\ti := bcd-digits\n\tload v1\n\ti := hex v0\n\tsprite v2 v3 5\n\tv2 += 5\n\ti := hex v1\n\tsprite v2 v3 5\n;\n\n:macro portal-touch {\n\tsfx sound-get\n\tplane 3\n\tclear\n\tplane 1\n\ti := long victory-data\n\tscreen-blit\n\n\t# display time and death counts:\n\tplane 2\n\ti := total-time-frac\n\tload v0\n\tv2 := 58\n\tv3 := 33\n\tbcd-byte\n\ti := total-time-sec\n\tload v0\n\tv2 += -17\n\tbcd-byte\n\ti := total-time-min\n\tload v0\n\tv2 += -17\n\tbcd-byte\n\n\ti := total-deaths\n\tload v0\n\tv2 := 83\n\tbcd-byte\n\n\t# wait for space, debounced:\n\tvf := OCTO_KEY_E\n\tloop if vf  key then again\n\tloop if vf -key then again\n\tloop if vf  key then again\n\n\tworld-reset\n\tjump main\n}\n\n:const GAME_TICK_RATE 3\n: increment-total-time\n\tv1 := 0\n\tloop\n\t\tvf := 1\n\t\t:macro inc-field ADDR {\n\t\t\ti := ADDR\n\t\t\tload v0 - v0\n\t\t\tv0 += vf\n\t\t\tvf := 0\n\t\t\tif v0 == 60 begin\n\t\t\t\tvf := 1\n\t\t\t\tv0 := 0\n\t\t\tend\n\t\t\tsave v0 - v0\n\t\t}\n\t\tinc-field total-time-frac\n\t\tinc-field total-time-sec\n\t\tinc-field total-time-min\n\n\t\tv1 += 1\n\t\tif v1 != GAME_TICK_RATE then\n\tagain\n;\n\n###########################################\n#\n#  Main Loop\n#\n###########################################\n\n: main\n\thires\n\tplane 3\n\tclear\n\tworld-reset\n\tboard-unpack\n\tboard-draw\n\tplayer-spawn\n\tplayer-init\n\ttitle-sequence\n\n: main-body\n\ttime := 0\n\tloop\n\t\tplayer-update\n\t\tboard-edges\n\t\tbat-update\n\t\tportal-animate\n\t\ttime += 1\n\t\tincrement-total-time\n\t\tvf := OCTO_KEY_1\n\t\tif vf key then jump main\n\t\tsync GAME_TICK_RATE\n\tagain\n\n:monitor total-deaths    1\n:monitor total-time-frac 3\n\n# changes:\n# v0.1 - first public beta\n# v0.2 - completed level design\n# v0.3 - added timer/death counter for speedrunning\n#      - added press 1 to hard-reset entire game (see above)\n#      - corrected a mistake in player spawn D for room 9\n","options":{"tickrate":1000,"fillColor":"lavender","fillColor2":"deeppink","blendColor":"deeppink","backgroundColor":"#100010","buzzColor":"black","quietColor":"black","shiftQuirks":false,"loadStoreQuirks":false,"vfOrderQuirks":false,"clipQuirks":true,"vBlankQuirks":false,"jumpQuirks":false,"screenRotation":0,"maxSize":"65024","touchInputMode":"none","logicQuirks":false,"fontStyle":"octo","displayScale":"6"},"rom":[20,97,0,3,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,162,39,242,101,64,0,0,238,242,1,96,28,128,18,128,6,128,6,240,0,16,32,240,30,240,101,130,4,240,0,16,0,96,6,128,18,128,4,128,4,240,30,209,40,0,238,0,0,162,88,241,101,65,255,0,238,242,1,240,0,16,40,208,24,0,238,96,255,97,255,162,88,241,85,0,238,162,4,240,101,240,41,97,1,98,122,209,37,113,5,240,0,16,48,209,37,0,238,96,0,97,0,98,16,99,32,100,48,208,16,243,30,208,32,243,30,208,48,243,30,208,64,243,30,112,16,48,128,18,150,0,238,87,115,111,1,255,30,240,2,247,24,0,238,96,0,162,39,240,85,34,108,162,2,240,101,240,0,39,250,240,30,240,30,241,101,162,220,241,85,97,0,98,0,99,0,240,0,0,0,243,30,240,101,48,254,18,236,162,25,81,34,96,0,48,255,18,246,162,27,81,34,96,0,48,252,19,0,162,29,81,34,96,0,48,253,19,10,162,31,81,34,96,0,48,251,19,22,96,255,162,39,242,85,96,0,48,250,19,48,162,2,240,101,240,0,2,5,240,30,240,101,48,0,19,46,162,88,81,34,96,0,240,0,24,250,243,30,240,85,113,8,65,128,114,4,65,128,97,0,115,1,51,0,18,218,0,238,243,1,97,0,98,0,99,0,240,0,24,250,243,30,240,101,240,0,24,138,240,30,209,36,113,8,65,128,114,4,65,128,97,0,115,1,51,0,19,82,34,42,34,90,162,2,240,101,48,0,19,134,241,1,240,0,16,53,34,140,0,238,107,0,108,0,110,0,109,0,162,3,240,101,48,0,19,156,111,1,142,241,162,25,240,30,240,30,89,163,0,238,242,1,240,0,40,78,217,168,162,33,96,0,129,144,130,160,242,85,162,36,96,32,240,85,0,238,129,148,111,240,143,23,79,0,19,206,97,1,19,214,111,128,143,23,63,0,97,127,129,22,129,22,129,22,240,0,24,250,241,30,0,238,129,164,111,240,143,23,79,0,19,242,97,1,19,250,111,64,143,23,63,0,97,63,98,252,129,34,129,30,129,30,241,30,81,19,0,238,0,0,0,164,8,240,51,164,9,241,101,240,41,210,53,114,5,241,41,210,53,0,238,97,0,111,1,162,22,80,3,128,244,111,0,48,60,20,51,111,1,96,0,80,2,162,23,80,3,128,244,111,0,48,60,20,69,111,1,96,0,80,2,162,24,80,3,128,244,111,0,48,60,20,87,111,1,96,0,80,2,113,1,49,3,20,33,0,238,0,255,243,1,0,224,162,2,96,0,97,3,98,0,242,85,162,5,96,0,97,0,240,85,113,1,49,20,20,119,34,186,35,74,35,136,35,166,241,1,99,0,96,20,111,6,239,161,20,219,111,9,239,161,20,219,111,7,239,161,20,219,255,7,63,0,20,159,111,3,255,21,112,255,48,0,20,141,240,0,41,94,243,30,241,101,98,0,240,0,40,246,242,30,208,24,111,3,255,21,255,7,63,0,20,197,208,24,114,8,50,40,20,185,115,2,67,6,99,0,20,139,104,0,99,0,111,4,143,226,79,0,20,241,111,6,239,161,20,241,111,251,142,242,111,7,239,158,21,7,108,4,111,2,143,226,63,0,108,2,107,255,111,1,142,241,59,255,21,67,96,0,100,0,97,0,35,192,97,0,35,228,111,40,143,23,63,0,100,1,97,0,35,192,97,7,35,228,111,40,143,23,63,0,100,1,68,0,21,57,107,0,108,0,128,192,144,192,21,67,112,1,121,255,21,13,111,9,239,158,21,89,108,4,111,2,143,226,63,0,108,2,107,1,111,254,142,242,59,1,21,149,96,0,100,0,97,7,35,192,97,0,35,228,111,40,143,23,63,0,100,1,97,7,35,192,97,7,35,228,111,40,143,23,63,0,100,1,68,0,21,139,107,0,108,0,128,192,144,192,21,149,112,1,121,1,21,95,111,1,143,226,63,0,115,56,111,2,143,226,79,0,22,111,111,6,239,158,21,223,111,11,143,213,79,0,21,223,111,8,143,226,79,0,21,223,111,4,143,226,63,0,21,223,111,247,142,242,111,6,142,241,109,0,122,255,162,36,96,0,129,144,130,160,242,85,240,0,24,53,34,174,240,0,40,230,253,30,240,101,111,64,143,2,79,0,22,39,100,0,97,2,35,192,97,255,35,228,111,40,143,23,63,0,100,1,97,6,35,192,97,255,35,228,111,40,143,23,63,0,100,1,68,0,22,25,109,9,96,0,64,0,22,35,122,255,112,1,21,239,115,40,22,105,64,0,22,105,100,0,97,2,35,192,97,8,35,228,111,32,143,23,63,0,100,1,97,6,35,192,97,8,35,228,111,32,143,23,63,0,100,1,68,0,22,93,111,245,142,242,96,0,240,0,24,87,34,174,64,0,22,103,122,1,112,255,22,43,115,48,61,15,125,1,23,19,111,6,239,158,22,155,111,4,143,226,63,0,22,151,111,6,142,241,109,0,122,255,162,36,96,0,129,144,130,160,242,85,240,0,24,53,34,174,22,153,22,155,23,19,60,0,124,255,76,0,107,0,59,0,22,201,109,0,96,0,97,2,35,192,97,7,35,228,65,32,96,1,97,6,35,192,97,7,35,228,65,32,96,1,48,0,122,255,22,231,111,3,143,210,63,1,22,215,240,0,24,70,34,174,115,8,125,1,128,208,111,6,128,242,128,14,128,14,131,4,100,0,97,2,35,192,97,8,35,228,111,32,143,23,63,0,100,1,97,6,35,192,97,8,35,228,111,32,143,23,63,0,100,1,52,0,23,19,111,10,142,241,109,9,242,1,162,33,242,101,111,128,143,23,63,0,23,49,111,64,143,39,63,0,23,49,240,0,40,78,240,30,209,40,111,128,143,151,63,0,24,113,111,64,143,167,63,0,24,113,240,0,40,78,243,30,217,168,79,0,24,113,162,2,240,101,48,0,23,179,240,0,24,121,34,174,243,1,0,224,241,1,240,0,20,53,34,140,242,1,162,22,240,101,98,58,99,33,36,11,162,23,240,101,114,239,36,11,162,24,240,101,114,239,36,11,162,21,240,101,98,83,36,11,111,6,239,161,23,141,239,158,23,145,239,161,23,149,162,2,96,0,97,3,98,0,242,85,162,5,96,0,97,0,240,85,113,1,49,20,23,169,20,97,162,88,240,101,64,255,24,7,34,90,34,90,79,0,24,7,240,0,24,121,34,174,98,9,34,90,111,3,255,21,255,7,63,0,23,209,114,255,50,0,23,203,34,108,162,2,240,101,240,0,2,5,240,30,96,1,240,85,240,0,2,4,80,3,112,1,80,2,34,118,111,60,255,21,255,7,63,0,23,253,34,118,24,113,240,0,40,78,243,30,217,168,241,1,162,36,242,101,64,32,24,37,240,0,40,198,240,30,112,8,209,40,24,21,162,21,80,3,48,99,112,1,80,2,240,0,24,104,34,174,240,0,40,190,217,168,111,30,255,21,255,7,63,0,24,63,217,168,35,136,242,1,240,0,40,78,111,1,143,226,63,0,240,0,40,134,96,8,217,168,111,3,255,21,255,7,63,0,24,97,112,255,48,0,24,91,35,166,20,219,162,33,128,48,129,144,130,160,242,85,241,1,162,36,242,101,64,32,24,147,240,0,40,198,240,30,209,40,112,8,162,36,242,85,111,240,143,149,63,0,24,203,111,255,143,151,63,0,24,203,162,2,82,35,240,0,40,22,242,30,242,30,242,30,242,30,240,101,64,255,24,203,162,2,97,0,241,85,34,186,243,1,0,224,35,74,105,120,35,166,111,128,143,149,63,0,25,3,111,144,143,151,63,0,25,3,162,2,82,35,240,0,40,23,242,30,242,30,242,30,242,30,240,101,64,255,25,3,162,2,97,1,241,85,34,186,243,1,0,224,35,74,105,0,35,166,111,240,143,165,63,0,25,59,111,255,143,167,63,0,25,59,162,2,82,35,240,0,40,24,242,30,242,30,242,30,242,30,240,101,64,255,25,59,162,2,97,2,241,85,34,186,243,1,0,224,35,74,106,56,35,166,111,61,143,165,63,0,25,115,111,77,143,167,63,0,25,115,162,2,82,35,240,0,40,25,242,30,242,30,242,30,242,30,240,101,64,255,25,115,162,2,97,3,241,85,34,186,243,1,0,224,35,74,106,0,35,166,34,42,113,254,162,40,81,18,34,42,162,2,240,101,48,0,25,163,162,4,240,101,48,8,25,163,242,1,240,0,41,30,96,14,128,130,128,14,128,14,240,30,96,72,97,33,208,24,120,1,36,31,111,1,239,161,20,97,255,7,63,0,25,173,111,3,255,21,20,221,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,92,254,255,113,88,0,0,0,0,60,254,254,95,0,0,0,0,48,248,248,122,94,44,0,0,60,254,254,94,0,0,0,0,255,254,255,0,1,2,1,192,180,93,117,47,122,14,57,47,73,79,73,143,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,1,0,1,0,0,0,0,0,0,3,231,3,247,3,54,3,55,3,54,3,55,3,55,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,112,7,248,7,219,6,155,54,131,54,195,54,195,54,99,54,115,54,59,55,59,55,27,54,27,54,27,54,27,54,27,54,155,54,153,182,217,246,248,230,240,6,0,0,0,0,207,63,223,191,25,140,159,140,31,140,217,140,217,140,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,128,62,199,191,207,183,108,49,108,49,108,49,110,49,206,51,204,51,204,54,140,62,12,60,12,54,12,54,12,54,12,51,12,51,12,49,12,49,15,177,7,176,0,0,0,0,124,0,126,0,102,0,124,0,102,0,126,0,124,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,128,0,128,0,128,0,128,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,128,0,128,0,128,0,0,0,0,0,0,0,204,0,204,0,252,0,120,0,48,0,48,0,48,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,3,0,12,0,48,0,64,1,128,2,15,4,48,8,128,17,0,16,0,34,0,32,0,32,0,35,248,45,132,50,2,52,2,20,2,29,6,6,24,0,96,1,128,6,3,8,12,16,16,16,0,32,64,32,128,32,128,32,128,17,0,17,0,16,0,16,129,8,6,4,10,2,20,1,147,0,127,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,7,248,56,7,192,0,0,0,0,0,0,0,0,0,128,0,120,195,0,195,0,195,0,99,0,99,0,103,0,102,0,54,0,54,0,54,0,54,0,54,0,30,0,28,60,12,192,0,0,0,0,0,0,0,0,0,0,8,0,0,0,8,0,0,0,0,30,0,97,192,128,32,0,33,0,34,64,68,64,132,129,8,2,0,2,8,2,0,3,0,0,248,0,7,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,15,0,48,0,64,0,128,0,192,192,64,56,192,7,128,0,0,0,0,7,0,15,158,109,222,108,204,108,204,108,204,108,12,108,12,108,12,108,12,108,12,108,204,108,204,108,204,111,204,103,140,96,0,0,0,0,0,0,0,0,0,0,0,0,0,0,128,0,0,0,0,0,0,64,0,128,15,0,48,0,64,0,128,1,1,2,1,2,129,6,66,5,194,4,66,2,130,255,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,127,192,152,60,32,7,64,56,0,64,0,71,0,184,0,192,0,128,0,0,0,0,57,230,125,246,237,187,205,155,205,153,205,153,205,153,205,185,205,241,205,225,205,241,205,177,205,153,237,153,253,141,121,140,1,128,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,1,0,0,0,0,0,0,129,0,66,0,68,0,132,3,8,12,8,16,16,33,16,66,16,68,0,136,0,168,192,236,63,195,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,128,0,0,0,248,0,7,192,0,32,0,24,0,4,0,2,27,63,59,65,51,60,99,2,231,1,198,0,198,0,134,0,134,30,140,1,140,0,140,0,140,0,128,0,140,0,140,0,0,1,0,0,0,0,0,0,0,1,0,0,64,0,128,0,64,1,0,2,0,3,0,0,2,0,1,128,0,64,0,32,128,16,128,8,0,4,0,2,0,2,0,1,0,1,0,0,248,0,7,0,0,224,0,28,0,2,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,128,0,64,0,32,0,16,0,16,0,200,0,36,0,4,0,2,0,2,0,1,0,61,0,199,0,97,0,24,0,4,0,130,0,98,0,9,0,1,0,241,0,9,0,5,0,135,0,75,0,38,0,16,0,16,0,16,0,8,0,8,0,8,0,8,0,8,0,8,0,8,0,144,0,144,0,16,0,80,0,16,0,32,0,160,0,160,0,64,0,64,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,227,142,56,227,142,56,199,28,113,199,28,113,206,56,227,142,1,2,33,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,165,223,113,220,80,29,56,151,90,125,223,181,229,244,151,213,4,2,33,0,8,102,0,216,1,176,32,16,16,0,0,0,0,4,248,248,248,248,248,248,248,248,248,248,248,248,248,248,248,248,0,0,0,0,0,0,0,0,126,66,126,66,0,0,0,0,0,0,0,0,0,34,102,102,0,0,0,0,102,102,34,0,126,36,0,0,0,0,0,0,255,255,255,255,0,0,0,0,255,247,98,64,0,0,0,0,255,0,255,255,0,0,0,0,127,128,191,255,0,0,0,0,254,1,253,255,0,0,0,0,255,126,129,0,0,0,0,0,119,85,119,0,0,0,0,0,127,65,65,65,0,0,0,0,65,65,127,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,48,40,48,0,0,0,0,0,0,0,0,0,0,0,48,48,0,48,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,253,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,255,0,0,0,0,0,0,0,0,0,0,0,0,0,0,254,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,56,56,56,56,56,56,56,56,56,56,56,56,72,0,64,56,40,40,40,40,40,40,40,40,40,40,40,40,40,0,40,40,40,40,40,40,40,40,40,40,40,40,40,40,40,0,40,40,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,40,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,40,0,0,0,0,0,0,0,0,0,0,0,253,0,0,0,40,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,40,0,0,0,0,0,0,0,0,0,0,0,32,0,0,0,40,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,40,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,40,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,40,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,40,0,0,0,0,0,0,0,0,0,0,0,0,32,32,0,40,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,40,255,0,0,0,0,0,0,0,0,252,0,0,0,0,0,40,0,0,0,64,72,0,0,0,0,0,0,0,0,0,0,40,56,56,0,40,40,56,56,56,56,72,0,0,0,0,16,40,40,40,16,40,40,40,40,40,40,40,0,0,0,0,40,40,40,40,40,40,40,40,40,40,40,40,0,0,0,0,0,40,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,255,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,56,56,56,72,0,0,0,0,0,0,0,0,0,0,0,0,40,40,40,40,0,0,0,0,0,0,0,0,0,0,0,0,40,40,40,40,0,0,0,0,0,0,0,0,0,0,0,0,40,40,40,40,56,56,56,72,0,0,0,0,0,0,0,254,40,40,40,40,40,40,40,40,0,0,0,0,0,0,0,0,40,40,40,40,40,40,40,40,56,56,56,56,56,56,56,56,40,40,40,40,40,40,40,40,40,40,40,40,40,40,40,40,40,40,40,40,40,40,40,40,40,40,40,40,40,40,40,40,40,40,40,40,40,40,40,40,40,40,40,40,40,253,40,40,40,40,40,40,40,40,40,40,40,40,40,40,48,0,48,40,0,0,0,48,48,0,0,0,48,0,0,48,0,0,0,48,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,251,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,255,0,0,0,0,0,0,0,0,0,0,0,0,0,0,254,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,88,88,88,88,0,96,96,88,88,0,0,0,0,0,96,96,88,96,88,88,88,104,104,88,88,88,96,88,88,88,104,104,88,104,88,88,88,88,88,88,88,88,104,88,88,88,88,88,88,88,88,96,88,88,88,88,88,88,88,88,96,88,88,88,40,40,40,40,40,40,40,40,40,40,0,0,0,253,0,40,40,40,40,40,40,40,40,40,40,40,0,0,0,0,0,40,0,0,0,48,48,0,48,40,40,48,0,0,0,0,0,40,0,0,0,0,0,0,0,48,48,0,0,0,0,0,0,40,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,40,0,0,0,0,0,0,0,0,250,0,0,0,0,0,0,40,0,0,0,0,0,0,0,0,0,0,0,0,0,16,16,40,0,0,0,0,0,0,0,0,88,88,0,0,0,40,40,40,0,0,88,0,0,0,0,0,96,88,0,0,0,48,40,40,0,0,0,0,0,0,0,0,104,96,0,0,0,0,0,0,255,0,0,0,0,0,0,0,88,104,0,0,0,0,0,254,0,0,0,0,0,0,0,0,88,88,0,0,0,0,0,0,96,96,88,88,88,0,0,0,88,88,0,0,0,96,96,96,104,104,88,96,96,0,0,0,96,88,0,0,0,104,104,104,0,0,88,104,104,0,0,0,104,88,0,0,0,96,96,96,0,0,88,88,88,0,0,0,0,0,0,0,0,104,104,104,40,40,40,40,40,40,40,40,40,40,40,40,40,40,40,40,40,40,40,40,48,48,0,0,0,0,0,0,48,40,40,40,40,40,40,48,0,0,0,0,0,0,250,0,0,40,40,88,40,88,40,0,0,0,0,0,0,0,0,0,0,40,88,88,40,88,40,0,0,0,64,56,56,56,72,0,0,40,40,40,40,40,40,0,0,0,40,40,40,40,40,0,0,40,40,40,40,40,88,0,0,64,40,40,40,40,40,0,0,40,40,40,88,88,88,0,0,40,0,0,24,24,24,0,0,88,40,40,88,88,88,32,32,48,0,0,0,0,0,0,0,88,88,88,0,0,0,0,0,0,0,0,0,0,0,0,0,88,88,88,255,0,0,0,0,0,0,0,0,0,0,0,0,96,96,96,0,0,0,0,0,0,0,0,0,0,0,0,0,104,104,104,96,96,96,96,96,0,0,96,96,96,96,0,0,96,96,96,104,104,104,104,104,16,16,104,104,104,104,16,16,104,104,104,0,0,96,96,96,96,96,96,96,96,96,96,96,96,96,96,0,0,104,104,104,104,104,104,104,104,104,104,104,104,104,104,88,88,88,88,88,0,0,0,0,0,0,0,0,88,104,104,88,88,88,96,96,0,0,0,0,0,0,0,253,88,88,104,88,96,96,104,104,0,0,0,0,0,0,0,0,88,96,96,88,104,104,88,88,0,0,0,0,0,0,0,0,88,104,104,96,96,88,0,88,0,0,0,0,0,0,0,0,0,88,88,104,104,0,0,0,0,0,0,0,0,0,0,0,0,96,96,96,96,0,0,0,0,0,0,0,0,0,0,0,0,104,104,104,104,0,0,0,0,0,0,0,0,0,0,0,0,96,96,96,0,0,0,0,0,0,0,0,0,0,0,0,0,104,104,104,0,0,0,0,0,0,0,0,0,0,0,0,0,96,96,255,0,0,0,0,0,0,0,0,0,0,0,0,0,104,104,0,0,0,0,0,0,0,0,0,0,0,0,88,88,88,88,96,96,0,0,0,0,96,96,0,0,0,0,96,96,96,96,104,104,16,16,16,16,104,104,16,16,16,16,104,104,104,104,96,96,96,96,96,96,96,96,96,96,96,96,96,96,96,96,104,104,104,104,104,104,104,104,104,104,104,104,104,104,104,104,96,96,96,96,96,96,96,96,88,88,88,88,88,88,96,96,104,104,104,104,104,104,104,104,24,24,24,24,24,24,104,104,255,0,0,0,0,0,0,0,0,0,0,0,250,0,96,96,0,0,0,0,0,0,0,0,0,0,0,0,0,0,104,104,88,88,88,88,88,88,88,88,0,0,88,88,0,88,96,96,88,88,24,24,24,24,24,24,0,0,24,24,0,24,104,104,96,96,0,0,0,0,0,0,0,0,0,0,0,0,96,96,104,104,0,0,0,0,0,0,0,0,0,0,0,0,104,104,96,96,88,0,0,88,88,88,88,88,88,88,88,88,96,96,104,104,24,0,0,24,24,24,24,24,24,24,24,24,104,104,96,96,0,0,0,0,0,0,0,0,0,0,0,0,0,254,104,104,0,0,0,0,0,0,0,0,0,0,0,0,0,0,96,96,96,96,96,96,96,96,96,96,96,96,96,96,96,96,104,104,104,104,104,104,104,104,104,104,104,104,104,104,104,104,0,0,96,96,96,96,96,96,96,96,96,96,96,96,96,96,0,0,104,104,104,104,104,104,104,104,104,104,104,104,104,104,96,96,96,96,96,96,96,96,96,96,96,0,0,96,96,96,104,104,104,104,104,104,104,104,104,104,104,0,0,104,104,104,96,96,0,0,0,0,0,0,0,0,0,0,0,0,0,254,104,104,0,0,0,0,0,0,0,0,0,0,0,0,0,0,96,96,0,0,0,0,0,0,0,0,96,96,96,96,96,96,104,104,0,0,0,0,0,0,0,0,104,104,104,104,104,104,88,88,0,0,0,0,0,0,0,0,96,88,88,88,88,88,88,88,16,16,0,16,16,0,32,0,104,88,88,88,88,88,88,88,88,88,250,88,88,0,0,0,96,88,88,88,88,88,88,88,88,88,0,88,88,0,0,0,104,88,88,88,88,88,88,88,0,88,0,88,0,0,0,0,96,88,88,88,88,88,88,88,0,0,0,0,0,0,32,0,104,88,88,88,88,88,88,96,0,0,0,0,0,0,0,0,96,88,88,88,88,88,88,104,0,0,0,0,0,0,0,0,104,88,88,88,88,88,40,40,16,16,16,0,0,0,88,88,88,88,88,88,88,88,40,40,88,88,88,88,88,88,88,88,88,88,88,88,88,88,40,40,40,40,40,40,40,40,40,40,40,40,40,40,40,40,40,40,40,40,40,40,40,40,40,40,40,40,40,40,40,40,0,0,0,0,0,48,0,0,0,0,0,0,48,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,250,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,251,0,0,0,32,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,32,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,255,0,0,0,0,0,0,0,0,0,0,0,0,0,0,254,0,0,0,0,0,0,0,0,0,0,88,32,32,88,0,0,88,96,88,0,0,0,88,88,88,96,88,0,252,88,88,88,88,104,88,16,16,16,88,88,88,104,88,0,0,88,88,88,40,40,88,88,96,88,96,88,88,88,88,32,32,88,88,88,40,40,88,88,104,88,104,88,88,88,88,0,0,88,88,88,40,40,40,40,40,40,40,40,40,40,40,0,0,40,40,40,40,40,40,40,40,40,40,40,40,40,40,0,0,48,40,40,40,40,48,0,0,0,0,0,0,0,48,0,0,0,48,0,96,48,0,0,0,0,0,0,0,0,0,32,32,0,0,0,104,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,88,0,0,0,0,64,56,56,56,72,0,0,0,0,0,0,96,0,250,0,0,40,40,40,40,40,0,32,32,0,0,0,104,0,0,0,0,40,48,0,0,0,0,0,0,0,0,251,96,0,0,0,0,40,0,0,0,0,0,0,0,0,0,0,104,0,0,0,0,0,0,0,0,0,0,32,32,0,0,0,88,16,0,0,0,0,0,0,0,0,0,0,0,0,0,254,96,88,16,0,0,0,0,0,0,0,0,0,0,0,0,0,104,96,96,16,88,88,88,88,88,88,88,88,88,88,88,96,88,104,104,88,88,88,88,88,88,88,88,88,96,88,96,104,40,40,88,88,88,88,88,88,96,88,88,88,104,88,104,88,40,40,88,88,88,88,88,88,104,88,88,88,88,88,88,88,40,40,48,0,0,0,0,0,48,40,48,48,0,0,0,0,40,48,0,0,0,0,0,0,0,48,0,0,0,0,0,0,40,0,0,0,0,0,0,0,0,0,0,0,0,0,0,251,40,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,40,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,40,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,40,0,0,0,0,0,0,0,0,0,0,64,72,0,0,254,40,0,0,0,0,0,0,64,72,0,64,40,40,0,0,0,40,0,0,0,64,56,56,40,40,56,40,40,40,56,56,56,40,0,0,0,40,40,40,40,40,40,40,40,40,40,40,40,40,0,0,0,0,0,0,0,0,0,0,0,48,40,40,40,40,0,0,0,0,0,0,0,0,0,0,0,0,40,40,40,40,72,0,0,0,0,0,0,0,0,0,0,0,40,40,40,40,40,56,56,56,56,56,56,56,56,72,0,252,40,40,40,40,40,40,40,40,40,40,40,40,40,40,0,0,40,40,40,40,40,40,40,40,40,40,40,40,40,40,32,32,40,40,40,0,0,0,0,0,0,0,0,0,0,0,48,40,40,40,40,0,0,0,0,0,0,0,0,0,0,0,0,48,48,40,40,0,0,0,0,0,0,0,0,0,0,0,0,0,0,48,40,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,40,0,0,0,0,0,0,0,0,0,250,0,0,0,0,0,40,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,40,72,0,0,0,0,0,0,0,64,72,0,0,0,0,0,40,40,0,32,32,0,0,0,0,40,40,0,0,0,0,0,40,48,0,0,0,0,0,0,0,24,24,0,0,0,0,0,40,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,40,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,40,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,40,0,0,0,0,0,32,32,0,0,0,0,0,0,0,0,40,0,0,0,0,0,0,0,0,0,0,0,252,0,0,0,40,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,40,0,0,0,0,0,0,0,0,0,0,0,32,0,0,0,40,40,40,48,0,0,0,0,0,0,0,0,0,0,0,0,0,40,40,0,0,0,0,0,0,0,0,0,0,0,0,0,0,40,40,0,0,0,0,0,0,0,0,0,0,0,0,0,0,40,40,0,0,0,0,0,0,0,0,0,0,0,0,0,0,40,40,0,0,0,0,0,0,0,0,0,0,0,0,0,254,40,40,0,0,0,0,0,0,0,0,0,0,0,0,0,0,40,40,0,0,0,0,0,0,0,0,0,0,64,56,56,56,40,48,0,0,250,0,0,0,0,0,0,0,40,40,40,40,40,0,0,0,0,0,0,0,0,0,0,0,48,48,40,48,40,0,0,0,32,0,0,0,32,0,0,0,0,0,48,0,40,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,40,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,40,16,0,0,0,16,16,16,0,0,0,0,0,0,0,0,40,40,0,0,0,48,40,48,0,0,0,0,0,0,0,0,40,40,16,0,0,0,48,0,0,0,0,0,0,0,0,16,40,40,40,0,0,0,0,0,0,0,0,0,0,0,16,40,25,250,26,250,27,250,28,250,29,250,30,250,31,250,32,250,33,250,34,250,35,250,36,250,37,250,38,250,2,1,13,3,0,255,12,4,11,0,255,255,9,4,0,255,3,5,1,6,4,255,255,255,7,255,4,255,8,6,255,255,255,7,9,255,10,3,255,8,255,9,11,255,255,2,255,10,13,255,255,1,255,12,255,0,0,60,40,60,126,126,60,36,0,60,40,60,252,60,60,36,60,40,60,252,60,60,40,8,0,60,40,60,252,60,60,24,60,40,60,252,60,60,24,16,60,40,60,60,126,60,40,0,0,60,169,126,60,60,60,36,0,60,20,60,126,126,60,36,0,60,20,60,63,60,60,36,60,20,60,63,60,60,20,16,0,60,20,60,63,60,60,24,60,20,60,63,60,60,24,8,60,20,60,60,126,60,20,0,0,60,149,126,60,60,60,36,0,60,137,126,60,60,60,66,0,0,0,0,0,0,24,0,0,0,0,0,0,56,102,24,0,0,0,0,0,56,102,24,0,0,0,0,0,0,24,0,253,253,253,254,254,255,255,255,0,1,1,1,2,2,3,3,0,0,40,16,40,0,0,0,0,16,16,108,16,16,0,0,198,170,108,0,108,170,198,0,0,16,16,108,16,16,0,0,0,0,40,16,40,0,0,0,0,0,0,16,0,0,0,0,0,0,16,40,16,0,0,0,0,56,68,84,68,56,0,0,56,68,146,170,146,68,56,0,56,68,146,170,146,68,56,0,0,56,68,84,68,56,0,0,0,0,16,40,16,0,0,0,0,0,0,16,0,0,0,0,42,3,82,25,35,39]}</script>
<script>"use strict";

function invertKeymap(k) {
	return Object.keys(k).reduce((a,b) => {
		Object.keys(k[b]).forEach(x => a[x]=+b)
		return a
	}, {})
}

function getPref(key) {
	try { return JSON.parse(localStorage.getItem(key)) }
	catch(e) { console.log(e); return null }
}
function setPref(key, value) {
	try { localStorage.setItem(key, JSON.stringify(value)) }
	catch(e) { console.log(e); }
}

var keymap = (this.STATIC_KEYMAP) || getPref('octoKeymap') || {
	0x0: { x:1 },
	0x1: { 1:1 },
	0x2: { 2:1 },
	0x3: { 3:1 },
	0x4: { q:1 },
	0x5: { w:1, ArrowUp:1 },
	0x6: { e:1, ' ':1 },
	0x7: { a:1, ArrowLeft:1 },
	0x8: { s:1, ArrowDown:1 },
	0x9: { d:1, ArrowRight:1 },
	0xA: { z:1 },
	0xB: { c:1 },
	0xC: { 4:1 },
	0xD: { r:1 },
	0xE: { f:1 },
	0xF: { v:1 },
}

var keymapInverse = invertKeymap(keymap)

var smallfonts = {
	octo: [
		0xF0, 0x90, 0x90, 0x90, 0xF0, // 0
		0x20, 0x60, 0x20, 0x20, 0x70, // 1
		0xF0, 0x10, 0xF0, 0x80, 0xF0, // 2
		0xF0, 0x10, 0xF0, 0x10, 0xF0, // 3
		0x90, 0x90, 0xF0, 0x10, 0x10, // 4
		0xF0, 0x80, 0xF0, 0x10, 0xF0, // 5
		0xF0, 0x80, 0xF0, 0x90, 0xF0, // 6
		0xF0, 0x10, 0x20, 0x40, 0x40, // 7
		0xF0, 0x90, 0xF0, 0x90, 0xF0, // 8
		0xF0, 0x90, 0xF0, 0x10, 0xF0, // 9
		0xF0, 0x90, 0xF0, 0x90, 0x90, // A
		0xE0, 0x90, 0xE0, 0x90, 0xE0, // B
		0xF0, 0x80, 0x80, 0x80, 0xF0, // C
		0xE0, 0x90, 0x90, 0x90, 0xE0, // D
		0xF0, 0x80, 0xF0, 0x80, 0xF0, // E
		0xF0, 0x80, 0xF0, 0x80, 0x80, // F
	],
	vip: [
		0xF0, 0x90, 0x90, 0x90, 0xF0,
		0x60, 0x20, 0x20, 0x20, 0x70,
		0xF0, 0x10, 0xF0, 0x80, 0xF0,
		0xF0, 0x10, 0xF0, 0x10, 0xF0,
		0xA0, 0xA0, 0xF0, 0x20, 0x20,
		0xF0, 0x80, 0xF0, 0x10, 0xF0,
		0xF0, 0x80, 0xF0, 0x90, 0xF0,
		0xF0, 0x10, 0x10, 0x10, 0x10,
		0xF0, 0x90, 0xF0, 0x90, 0xF0,
		0xF0, 0x90, 0xF0, 0x10, 0xF0,
		0xF0, 0x90, 0xF0, 0x90, 0x90,
		0xF0, 0x50, 0x70, 0x50, 0xF0,
		0xF0, 0x80, 0x80, 0x80, 0xF0,
		0xF0, 0x50, 0x50, 0x50, 0xF0,
		0xF0, 0x80, 0xF0, 0x80, 0xF0,
		0xF0, 0x80, 0xF0, 0x80, 0x80,
	],
	dream6800: [
		0xE0, 0xA0, 0xA0, 0xA0, 0xE0,
		0x40, 0x40, 0x40, 0x40, 0x40,
		0xE0, 0x20, 0xE0, 0x80, 0xE0,
		0xE0, 0x20, 0xE0, 0x20, 0xE0,
		0x80, 0xA0, 0xA0, 0xE0, 0x20,
		0xE0, 0x80, 0xE0, 0x20, 0xE0,
		0xE0, 0x80, 0xE0, 0xA0, 0xE0,
		0xE0, 0x20, 0x20, 0x20, 0x20,
		0xE0, 0xA0, 0xE0, 0xA0, 0xE0,
		0xE0, 0xA0, 0xE0, 0x20, 0xE0,
		0xE0, 0xA0, 0xE0, 0xA0, 0xA0,
		0xC0, 0xA0, 0xE0, 0xA0, 0xC0,
		0xE0, 0x80, 0x80, 0x80, 0xE0,
		0xC0, 0xA0, 0xA0, 0xA0, 0xC0,
		0xE0, 0x80, 0xE0, 0x80, 0xE0,
		0xE0, 0x80, 0xC0, 0x80, 0x80,
	],
	eti660: [
		0xE0, 0xA0, 0xA0, 0xA0, 0xE0,
		0x20, 0x20, 0x20, 0x20, 0x20,
		0xE0, 0x20, 0xE0, 0x80, 0xE0,
		0xE0, 0x20, 0xE0, 0x20, 0xE0,
		0xA0, 0xA0, 0xE0, 0x20, 0x20,
		0xE0, 0x80, 0xE0, 0x20, 0xE0,
		0xE0, 0x80, 0xE0, 0xA0, 0xE0,
		0xE0, 0x20, 0x20, 0x20, 0x20,
		0xE0, 0xA0, 0xE0, 0xA0, 0xE0,
		0xE0, 0xA0, 0xE0, 0x20, 0xE0,
		0xE0, 0xA0, 0xE0, 0xA0, 0xA0,
		0x80, 0x80, 0xE0, 0xA0, 0xE0,
		0xE0, 0x80, 0x80, 0x80, 0xE0,
		0x20, 0x20, 0xE0, 0xA0, 0xE0,
		0xE0, 0x80, 0xE0, 0x80, 0xE0,
		0xE0, 0x80, 0xC0, 0x80, 0x80,
	],
	fish: [
		0x60, 0xA0, 0xA0, 0xA0, 0xC0,
		0x40, 0xC0, 0x40, 0x40, 0xE0,
		0xC0, 0x20, 0x40, 0x80, 0xE0,
		0xC0, 0x20, 0x40, 0x20, 0xC0,
		0x20, 0xA0, 0xE0, 0x20, 0x20,
		0xE0, 0x80, 0xC0, 0x20, 0xC0,
		0x40, 0x80, 0xC0, 0xA0, 0x40,
		0xE0, 0x20, 0x60, 0x40, 0x40,
		0x40, 0xA0, 0x40, 0xA0, 0x40,
		0x40, 0xA0, 0x60, 0x20, 0x40,
		0x40, 0xA0, 0xE0, 0xA0, 0xA0,
		0xC0, 0xA0, 0xC0, 0xA0, 0xC0,
		0x60, 0x80, 0x80, 0x80, 0x60,
		0xC0, 0xA0, 0xA0, 0xA0, 0xC0,
		0xE0, 0x80, 0xC0, 0x80, 0xE0,
		0xE0, 0x80, 0xC0, 0x80, 0x80,
	],
}
var bigfonts = {
	octo: [
		0xFF, 0xFF, 0xC3, 0xC3, 0xC3, 0xC3, 0xC3, 0xC3, 0xFF, 0xFF, // 0
		0x18, 0x78, 0x78, 0x18, 0x18, 0x18, 0x18, 0x18, 0xFF, 0xFF, // 1
		0xFF, 0xFF, 0x03, 0x03, 0xFF, 0xFF, 0xC0, 0xC0, 0xFF, 0xFF, // 2
		0xFF, 0xFF, 0x03, 0x03, 0xFF, 0xFF, 0x03, 0x03, 0xFF, 0xFF, // 3
		0xC3, 0xC3, 0xC3, 0xC3, 0xFF, 0xFF, 0x03, 0x03, 0x03, 0x03, // 4
		0xFF, 0xFF, 0xC0, 0xC0, 0xFF, 0xFF, 0x03, 0x03, 0xFF, 0xFF, // 5
		0xFF, 0xFF, 0xC0, 0xC0, 0xFF, 0xFF, 0xC3, 0xC3, 0xFF, 0xFF, // 6
		0xFF, 0xFF, 0x03, 0x03, 0x06, 0x0C, 0x18, 0x18, 0x18, 0x18, // 7
		0xFF, 0xFF, 0xC3, 0xC3, 0xFF, 0xFF, 0xC3, 0xC3, 0xFF, 0xFF, // 8
		0xFF, 0xFF, 0xC3, 0xC3, 0xFF, 0xFF, 0x03, 0x03, 0xFF, 0xFF, // 9
		0x7E, 0xFF, 0xC3, 0xC3, 0xC3, 0xFF, 0xFF, 0xC3, 0xC3, 0xC3, // A
		0xFC, 0xFC, 0xC3, 0xC3, 0xFC, 0xFC, 0xC3, 0xC3, 0xFC, 0xFC, // B
		0x3C, 0xFF, 0xC3, 0xC0, 0xC0, 0xC0, 0xC0, 0xC3, 0xFF, 0x3C, // C
		0xFC, 0xFE, 0xC3, 0xC3, 0xC3, 0xC3, 0xC3, 0xC3, 0xFE, 0xFC, // D
		0xFF, 0xFF, 0xC0, 0xC0, 0xFF, 0xFF, 0xC0, 0xC0, 0xFF, 0xFF, // E
		0xFF, 0xFF, 0xC0, 0xC0, 0xFF, 0xFF, 0xC0, 0xC0, 0xC0, 0xC0  // F
	],
	schip: [
		0x3C, 0x7E, 0xE7, 0xC3, 0xC3, 0xC3, 0xC3, 0xE7, 0x7E, 0x3C,
		0x18, 0x38, 0x58, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x3C,
		0x3E, 0x7F, 0xC3, 0x06, 0x0C, 0x18, 0x30, 0x60, 0xFF, 0xFF,
		0x3C, 0x7E, 0xC3, 0x03, 0x0E, 0x0E, 0x03, 0xC3, 0x7E, 0x3C,
		0x06, 0x0E, 0x1E, 0x36, 0x66, 0xC6, 0xFF, 0xFF, 0x06, 0x06,
		0xFF, 0xFF, 0xC0, 0xC0, 0xFC, 0xFE, 0x03, 0xC3, 0x7E, 0x3C,
		0x3E, 0x7C, 0xE0, 0xC0, 0xFC, 0xFE, 0xC3, 0xC3, 0x7E, 0x3C,
		0xFF, 0xFF, 0x03, 0x06, 0x0C, 0x18, 0x30, 0x60, 0x60, 0x60,
		0x3C, 0x7E, 0xC3, 0xC3, 0x7E, 0x7E, 0xC3, 0xC3, 0x7E, 0x3C,
		0x3C, 0x7E, 0xC3, 0xC3, 0x7F, 0x3F, 0x03, 0x03, 0x3E, 0x7C,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, // no hex chars!
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	],
	fish: [
		0x7C, 0xC6, 0xCE, 0xDE, 0xD6, 0xF6, 0xE6, 0xC6, 0x7C, 0x00, // at most 7x9 pixels!
		0x10, 0x30, 0xF0, 0x30, 0x30, 0x30, 0x30, 0x30, 0xFC, 0x00,
		0x78, 0xCC, 0xCC, 0x0C, 0x18, 0x30, 0x60, 0xCC, 0xFC, 0x00,
		0x78, 0xCC, 0x0C, 0x0C, 0x38, 0x0C, 0x0C, 0xCC, 0x78, 0x00,
		0x0C, 0x1C, 0x3C, 0x6C, 0xCC, 0xFE, 0x0C, 0x0C, 0x1E, 0x00,
		0xFC, 0xC0, 0xC0, 0xC0, 0xF8, 0x0C, 0x0C, 0xCC, 0x78, 0x00,
		0x38, 0x60, 0xC0, 0xC0, 0xF8, 0xCC, 0xCC, 0xCC, 0x78, 0x00,
		0xFE, 0xC6, 0xC6, 0x06, 0x0C, 0x18, 0x30, 0x30, 0x30, 0x00,
		0x78, 0xCC, 0xCC, 0xEC, 0x78, 0xDC, 0xCC, 0xCC, 0x78, 0x00,
		0x7C, 0xC6, 0xC6, 0xC6, 0x7C, 0x18, 0x18, 0x30, 0x70, 0x00,
		0x30, 0x78, 0xCC, 0xCC, 0xCC, 0xFC, 0xCC, 0xCC, 0xCC, 0x00,
		0xFC, 0x66, 0x66, 0x66, 0x7C, 0x66, 0x66, 0x66, 0xFC, 0x00,
		0x3C, 0x66, 0xC6, 0xC0, 0xC0, 0xC0, 0xC6, 0x66, 0x3C, 0x00,
		0xF8, 0x6C, 0x66, 0x66, 0x66, 0x66, 0x66, 0x6C, 0xF8, 0x00,
		0xFE, 0x62, 0x60, 0x64, 0x7C, 0x64, 0x60, 0x62, 0xFE, 0x00,
		0xFE, 0x66, 0x62, 0x64, 0x7C, 0x64, 0x60, 0x60, 0xF0, 0x00,
	],
	none: new Array(16*10).fill(0x00),
}
var fontsets = {
	octo     : { small: smallfonts.octo,      big: bigfonts.octo  },
	vip      : { small: smallfonts.vip,       big: bigfonts.none  },
	dream6800: { small: smallfonts.dream6800, big: bigfonts.none  },
	eti660   : { small: smallfonts.eti660,    big: bigfonts.none  },
	schip    : { small: smallfonts.octo,      big: bigfonts.schip },
	fish     : { small: smallfonts.fish,      big: bigfonts.fish  },
}

////////////////////////////////////
//
//   The Chip8 Interpreter:
//
////////////////////////////////////

function Emulator() {

	// persistent configuration settings
	this.tickrate           = 20;
	this.fillColor          = "#FFCC00";
	this.fillColor2         = "#FF6600";
	this.blendColor         = "#662200";
	this.backgroundColor    = "#996600";
	this.buzzColor          = "#FFAA00";
	this.quietColor         = "#000000";
	this.shiftQuirks        = false;
	this.loadStoreQuirks    = false;
	this.vfOrderQuirks      = false;
	this.clipQuirks         = false;
	this.jumpQuirks         = false;
	this.logicQuirks        = false;
	this.vBlankQuirks       = false;
	this.enableXO           = true;
	this.screenRotation     = 0;//must be 0, 90, 180, or 270
	this.maxSize            = 3584;
	this.touchInputMode     = 'none';
	this.maskFormatOverride = true;
	this.numericFormatStr   = "default";
	this.fontStyle          = 'octo';

	// interpreter state
	this.p  = [[],[]];  // pixels
	this.m  = [];       // memory (bytes)
	this.r  = [];       // return stack
	this.v  = [];       // registers
	this.pc = 0;        // program counter
	this.i  = 0;        // index register
	this.dt = 0;        // delay timer
	this.st = 0;        // sound timer
	this.hires = false; // are we in SuperChip high res mode?
	this.flags = [];    // semi-persistent hp48 flag vars
	this.pattern = [];  // audio pattern buffer
	this.plane = 1;     // graphics plane
	this.profile_data = {};

	// control/debug state
	this.keys = {};       // track keys which are pressed
	this.waiting = false; // are we waiting for a keypress?
	this.waitReg = -1;    // destination register of an awaited key
	this.halted = true;
	this.breakpoint = false;
	this.metadata = {};
	this.tickCounter = 0;
	this.linted = false;

	// external interface stubs
	this.exitVector  = function() {}                                   // fired by 'exit'
	this.importFlags = function() { return [0, 0, 0, 0, 0, 0, 0, 0]; } // load persistent flags
	this.exportFlags = function(flags) {}                              // save persistent flags
	this.buzzTrigger = function(ticks, remainingTicks) {}                              // fired when buzzer played

	this.init = function(rom) {
		// initialise memory with a new array to ensure that it is of the right size and is initiliased to 0
		this.m = this.enableXO ? new Uint8Array(0x10000) : new Uint8Array(0x1000);

		this.p = [[], []];
		if (this.enableXO)
			for(var z = 0; z < 64*128; z++) { this.p[0][z] = 0; this.p[1][z] = 0; }
		else
			for(var z = 0; z < 32*64; z++) { this.p[0][z] = 0; this.p[1][z] = 0; }

		// initialize memory
		var font = fontsets[this.fontStyle];
		for(var z = 0; z < 32*64;            z++) { this.p[0][z] = 0; this.p[1][z] = 0; }
		for(var z = 0; z < font.small.length;z++) { this.m[z] = font.small[z]; }
		for(var z = 0; z < font.big.length;  z++) { this.m[z + font.small.length] = font.big[z]; }
		for(var z = 0; z < rom.rom.length;   z++) { this.m[0x200+z] = rom.rom[z]; }
		for(var z = 0; z < 16;               z++) { this.v[z] = 0; }
		for(var z = 0; z < 16;               z++) { this.pattern[z] = 0; }

		// initialize interpreter state
		this.r = [];
		this.pc = 0x200;
		this.i  = 0;
		this.dt = 0;
		this.st = 0;
		this.hires = false;
		this.plane = 1;

		// initialize control/debug state
		this.keys = {};
		this.waiting = false;
		this.waitReg = -1;
		this.halted = false;
		this.breakpoint = false;
		this.stack_breakpoint = -1;
		this.metadata = rom;
		this.tickCounter = 0;
		this.profile_data = {};
	}

	this.writeCarry = function(dest, value, flag) {
		this.v[dest] = (value & 0xFF);
		this.v[0xF] = flag ? 1 : 0;
		if (this.vfOrderQuirks) {
			this.v[dest] = (value & 0xFF);
		}
	}

	this.math = function(x, y, op) {
		// basic arithmetic opcodes
		switch(op) {
			case 0x0: this.v[x]  = this.v[y]; break;
			case 0x1: this.v[x] |= this.v[y]; if (this.logicQuirks) this.v[0xF]=0; break;
			case 0x2: this.v[x] &= this.v[y]; if (this.logicQuirks) this.v[0xF]=0; break;
			case 0x3: this.v[x] ^= this.v[y]; if (this.logicQuirks) this.v[0xF]=0; break;
			case 0x4:
				var t = this.v[x]+this.v[y];
				this.writeCarry(x, t, (t > 0xFF));
				break;
			case 0x5:
				var t = this.v[x]-this.v[y];
				this.writeCarry(x, t, (this.v[x] >= this.v[y]));
				break;
			case 0x7:
				var t = this.v[y]-this.v[x];
				this.writeCarry(x, t, (this.v[y] >= this.v[x]));
				break;
			case 0x6:
				if (this.shiftQuirks) { y = x; }
				var t = this.v[y] >> 1;
				this.writeCarry(x, t, (this.v[y] & 0x1));
				break;
			case 0xE:
				if (this.shiftQuirks) { y = x; }
				var t = this.v[y] << 1;
				this.writeCarry(x, t, ((this.v[y] >> 7) & 0x1));
				break;
			default:
				haltBreakpoint("unknown math opcode "+op);
		}
	}

	this.misc = function(x, rest) {
		// miscellaneous opcodes
		switch(rest) {
			case 0x01:
				this.plane = (x & 0x3);
				break;
			case 0x02:
				for(var z = 0; z < 16; z++) {
					this.pattern[z] = this.m[this.i+z];
				}
				break;
			case 0x07: this.v[x] = this.dt; break;
			case 0x0A: this.waiting = true; this.waitReg = x; break;
			case 0x15: this.dt = this.v[x]; break;
			case 0x18: this.buzzTrigger(this.v[x], this.st); this.st = this.v[x]; break;
			case 0x1E: this.i = (this.i + this.v[x])&0xFFFF; break;
			case 0x29: this.i = ((this.v[x] & 0xF) * 5); break;
			case 0x30: this.i = ((this.v[x] & 0xF) * 10 + fontsets[this.fontStyle].small.length); break;
			case 0x33:
				this.m[this.i]   = Math.floor(this.v[x]/100)%10;
				this.m[this.i+1] = Math.floor(this.v[x]/10)%10;
				this.m[this.i+2] = this.v[x]%10;
				break;
			case 0x55:
				for(var z = 0; z <= x; z++) { this.m[this.i+z] = this.v[z]; }
				if (!this.loadStoreQuirks) { this.i = (this.i+x+1)&0xFFFF; }
				break;
			case 0x65:
				for(var z = 0; z <= x; z++) { this.v[z] = this.m[this.i+z]; }
				if (!this.loadStoreQuirks) { this.i = (this.i+x+1)&0xFFFF; }
				break;
			case 0x75:
				for(var z = 0; z <= x; z++) { this.flags[z] = this.v[z]; }
				this.exportFlags(this.flags);
				break;
			case 0x85:
				this.flags = this.importFlags();
				if (typeof this.flags == "undefined" || this.flags == null) {
					this.flags = [0, 0, 0, 0, 0, 0, 0, 0];
				}
				for(var z = 0; z <= x; z++) { this.v[z] = this.flags[z]; }
				break;
			default:
				haltBreakpoint("unknown misc opcode "+rest);
		}
	}

	this.sprite = function sprite(x, y, len) {
		this.v[0xF] = 0x0;
		var rowSize = this.hires ? 128 : 64;
		var colSize = this.hires ?  64 : 32;
		var i = this.i;
		for(var layer = 0; layer < 2; layer++) {
			if ((this.plane & (layer+1)) == 0) { continue; }
			if (len == 0) {
				// draw a SuperChip 16x16 sprite
				for(var a = 0; a < 16; a++) {
					for(var b = 0; b < 16; b++) {
						var target = ((x+b) % rowSize) + ((y+a) % colSize)*rowSize;
						var source = ((this.m[i+(a*2)+(b > 7 ? 1:0)] >> (7-(b%8))) & 0x1) != 0;
						if (this.clipQuirks) {
							if ((x%rowSize)+b>=rowSize || (y%colSize)+a>=colSize) { source = 0; }
						}
						if (!source) { continue; }
						if (this.p[layer][target]) { this.p[layer][target] = 0; this.v[0xF] = 0x1; }
						else { this.p[layer][target] = 1; }
					}
				}
				i += 32;
			}
			else {
				// draw a Chip8 8xN sprite
				for(var a = 0; a < len; a++) {
					for(var b = 0; b < 8; b++) {
						var target = ((x+b) % rowSize) + ((y+a) % colSize)*rowSize;
						var source = ((this.m[i+a] >> (7-b)) & 0x1) != 0;
						if (this.clipQuirks) {
							if ((x%rowSize)+b>=rowSize || (y%colSize)+a>=colSize) { source = 0; }
						}
						if (!source) { continue; }
						if (this.p[layer][target]) { this.p[layer][target] = 0; this.v[0xF] = 0x1; }
						else { this.p[layer][target] = 1; }
					}
				}
				i += len;
			}
		}
	}

	this.call = function(nnn) {
		if (this.r.length >= 12) {
			haltBreakpoint("call stack overflow.");
		}
		this.r.push(this.pc);
		this.pc = nnn
	}

	this.jump0 = function(nnn) {
		if (this.jumpQuirks) { this.pc = nnn + this.v[(nnn >> 8)&0xF];  }
		else                 { this.pc = nnn + this.v[0]; }
	}

	this.machine = function(nnn) {
		if (nnn == 0x000) { this.halted = true; return; }
		haltBreakpoint("machine code is not supported.");
	}

	this.skip = function() {
		var op = (this.m[this.pc  ] << 8) | this.m[this.pc+1];
		this.pc += (op == 0xF000) ? 4 : 2;
	}

	this.opcode = function() {
		// Increment profilining data
		this.profile_data[this.pc] = (this.profile_data[this.pc] || 0) + 1;

		// decode the current opcode
		var op  = (this.m[this.pc  ] << 8) | this.m[this.pc+1];
		var o   = (this.m[this.pc  ] >> 4) & 0x00F;
		var x   = (this.m[this.pc  ]     ) & 0x00F;
		var y   = (this.m[this.pc+1] >> 4) & 0x00F;
		var n   = (this.m[this.pc+1]     ) & 0x00F;
		var nn  = (this.m[this.pc+1]     ) & 0x0FF;
		var nnn = op & 0xFFF;
		this.pc += 2;

		// execute a simple opcode
		if (op == 0x00E0) {
			// clear
			for(var layer = 0; layer < 2; layer++) {
				if ((this.plane & (layer+1)) == 0) { continue; }
				for(var z = 0; z < this.p[layer].length; z++) {
					this.p[layer][z] = 0;
				}
			}
			return;
		}
		if (op == 0x00EE) {
			// return
			this.pc = this.r.pop();
			return;
		}
		if ((op & 0xF0FF) == 0xE09E) {
			// if -key
			if (Object.keys(keymap[this.v[x]]).some(x => x in this.keys)) { this.skip(); }
			return;
		}
		if ((op & 0xF0FF) == 0xE0A1) {
			// if key
			if (!Object.keys(keymap[this.v[x]]).some(x => x in this.keys)) { this.skip(); }
			return;
		}
		if ((op & 0xFFF0) == 0x00C0) {
			// scroll down n pixels
			var rowSize = this.hires ? 128 : 64;
			for(var layer = 0; layer < 2; layer++) {
				if ((this.plane & (layer+1)) == 0) { continue; }
				for(var z = this.p[layer].length - 1; z >= 0; z--) {
					this.p[layer][z] = (z >= rowSize * n) ? this.p[layer][z - (rowSize * n)] : 0;
				}
			}
			return;
		}
		if ((op & 0xFFF0) == 0x00D0) {
			// scroll up n pixels
			var rowSize = this.hires ? 128 : 64;
			for(var layer = 0; layer < 2; layer++) {
				if ((this.plane & (layer+1)) == 0) { continue; }
				for(var z = 0; z < this.p[layer].length; z++) {
					this.p[layer][z] = (z < (this.p[layer].length - rowSize * n)) ? this.p[layer][z + (rowSize * n)] : 0;
				}
			}
			return;
		}
		if (op == 0x00FB) {
			// scroll right 4 pixels
			var rowSize = this.hires ? 128 : 64;
			for(var layer = 0; layer < 2; layer++) {
				if ((this.plane & (layer+1)) == 0) { continue; }
				for(var a = 0; a < this.p[layer].length; a += rowSize) {
					for(var b = rowSize-1; b >= 0; b--) {
						this.p[layer][a + b] = (b > 3) ? this.p[layer][a + b - 4] : 0;
					}
				}
			}
			return;
		}
		if (op == 0x00FC) {
			// scroll left 4 pixels
			var rowSize = this.hires ? 128 : 64;
			for(var layer = 0; layer < 2; layer++) {
				if ((this.plane & (layer+1)) == 0) { continue; }
				for(var a = 0; a < this.p[layer].length; a += rowSize) {
					for(var b = 0; b < rowSize; b++) {
						this.p[layer][a + b] = (b < rowSize - 4) ? this.p[layer][a + b + 4] : 0;
					}
				}
			}
			return;
		}
		if (op == 0x00FD) {
			// exit
			this.halted = true;
			this.exitVector();
			return;
		}
		if (op == 0x00FE) {
			// lores
			this.hires = false;
			this.p = [[], []];
			for(var z = 0; z < 32*64; z++) { this.p[0][z] = 0; this.p[1][z] = 0; }
			return;
		}
		if (op == 0x00FF) {
			// hires
			this.hires = true;
			this.p = [[], []];
			for(var z = 0; z < 64*128; z++) { this.p[0][z] = 0; this.p[1][z] = 0; }
			return;
		}
		if (op == 0xF000) {
			// long memory reference
			this.i = ((this.m[this.pc] << 8) | (this.m[this.pc+1])) & 0xFFFF;
			this.pc += 2;
			return;
		}

		if (o == 0x5 && n != 0) {
			if (n == 2) {
				// save range
				var dist = Math.abs(x - y);
				if (x < y) { for(var z = 0; z <= dist; z++) { this.m[this.i+z] = this.v[x+z]; }}
				else       { for(var z = 0; z <= dist; z++) { this.m[this.i+z] = this.v[x-z]; }}
				return;
			}
			else if (n == 3) {
				// load range
				var dist = Math.abs(x - y);
				if (x < y) { for(var z = 0; z <= dist; z++) { this.v[x+z] = this.m[this.i+z]; }}
				else       { for(var z = 0; z <= dist; z++) { this.v[x-z] = this.m[this.i+z]; }}
				return;
			}
			else {
				haltBreakpoint("unknown opcode "+op);
			}
		}
		if (o == 0x9 && n != 0) {
			haltBreakpoint("unknown opcode "+op);
		}

		// dispatch complex opcodes
		switch(o) {
			case 0x0: this.machine(nnn);                            break;
			case 0x1: this.pc = nnn;                                break;
			case 0x2: this.call(nnn);                               break;
			case 0x3: if (this.v[x] == nn)        { this.skip(); }  break;
			case 0x4: if (this.v[x] != nn)        { this.skip(); }  break;
			case 0x5: if (this.v[x] == this.v[y]) { this.skip(); }  break;
			case 0x6: this.v[x] = nn;                               break;
			case 0x7: this.v[x] = (this.v[x] + nn) & 0xFF;          break;
			case 0x8: this.math(x, y, n);                           break;
			case 0x9: if (this.v[x] != this.v[y]) { this.skip(); }  break;
			case 0xA: this.i = nnn;                                 break;
			case 0xB: this.jump0(nnn);                              break;
			case 0xC: this.v[x] = (Math.random()*256)&nn;           break;
			case 0xD: this.sprite(this.v[x], this.v[y], n);         break;
			case 0xF: this.misc(x, nn);                             break;
			default: haltBreakpoint("unknown opcode "+o);
		}
	}

	this.tick = function() {
		if (this.halted) { return; }
		this.tickCounter++;
		try {
			this.opcode();
		}
		catch(err) {
			console.log("halted: " + err);
			this.halted = true;
		}
	}
}
</script>
<script>"use strict";

////////////////////////////////////
//
//   Emulator Execution
//
////////////////////////////////////

//must be set > 0
var scaleFactor = 5;
//dom id for canvas element
var renderTarget = "target";

const optionFlags = [
	"tickrate",
	"fillColor",
	"fillColor2",
	"blendColor",
	"backgroundColor",
	"buzzColor",
	"quietColor",
	"shiftQuirks",
	"loadStoreQuirks",
	"vfOrderQuirks",
	"clipQuirks",
	"vBlankQuirks",
	"jumpQuirks",
	"screenRotation",
	"maxSize",
	"touchInputMode",
	"logicQuirks",
	"fontStyle",
]
function unpackOptions(emulator, options) {
	optionFlags.forEach(x => { if (x in options) emulator[x] = options[x] })
	if (options["enableXO"]) emulator.maxSize = 65024 // legacy option
}
function packOptions(emulator) {
	const r = {}
	optionFlags.forEach(x => r[x] = emulator[x])
	return r
}

function setRenderTarget(scale, canvas) {
	scaleFactor = scale;
	renderTarget = canvas;
	var c = document.getElementById(canvas);

	// Remove any existing previous delta frame so first frame is always drawn:
	c.last = undefined;

	var w  = scaleFactor * 128;
	var h  = scaleFactor *  64;

	if (emulator.screenRotation == 90 || emulator.screenRotation == 270) {
		c.width  = h;
		c.height = w;
	}
	else {
		c.width  = w;
		c.height = h;
	}
}

function setTransform(emulator, g) {
	g.setTransform(1, 0, 0, 1, 0, 0);
	var x = scaleFactor * 128;
	var y = scaleFactor *  64;
	switch(emulator.screenRotation) {
		case 90:
			g.rotate(0.5 * Math.PI);
			g.translate(0, -y);
			break;
		case 180:
			g.rotate(1.0 * Math.PI);
			g.translate(-x, -y);
			break;
		case 270:
			g.rotate(1.5 * Math.PI);
			g.translate(-x, 0);
			break;
		default:
			console.assert(emulator.screenRotation === 0, 'Screen rotation not set to 0, 90, 180, or 270. Treating as 0.')
	}
}


function arrayEqual(a, b) {
	var length = a.length;
	if (length !== b.length) { return false; }
	for (var i = 0; i < length; i++) {
		if (a[i] !== b[i]) { return false; }
	}
	return true;
}

function getColor(id) {
	switch(id) {
		case 0: return emulator.backgroundColor;
		case 1: return emulator.fillColor;
		case 2: return emulator.fillColor2;
		case 3: return emulator.blendColor;
	}
	throw "invalid color: " + id;
}

function renderDisplay(emulator) {
	var c = document.getElementById(renderTarget);

	// Canvas rendering can be expensive. Exit out early if nothing has changed.
	var colors = [emulator.backgroundColor, emulator.fillColor, emulator.fillColor2, emulator.blendColor];
	if (c.last !== undefined) {
		if (arrayEqual(c.last.p[0], emulator.p[0]) && arrayEqual(c.last.p[1], emulator.p[1])
				&& arrayEqual(c.last.colors, colors)) {
			return;
		}
		if (c.last.hires !== emulator.hires)
			c.last = undefined;  // full redraw when switching resolution
	}
	var g = c.getContext("2d");
	setTransform(emulator, g);
	var w      = emulator.hires ? 128         : 64;
	var h      = emulator.hires ? 64          : 32;
	var size   = emulator.hires ? scaleFactor : scaleFactor*2;
	var lastPixels = c.last !== undefined? c.last.p: [[], []]

	g.scale(size, size)
	var z = 0;
	for(var y = 0; y < h; ++y) {
		for(var x = 0; x < w; ++x, ++z) {
			var oldColorIdx = lastPixels[0][z] + (lastPixels[1][z] << 1);
			var colorIdx = emulator.p[0][z] + (emulator.p[1][z] << 1);
			if (oldColorIdx !== colorIdx) {
				g.fillStyle = getColor(colorIdx);
				g.fillRect(x, y, 1, 1);
			}
		}
	}
	g.scale(1, 1) //restore scale to 1,1 just in case

	c.last = {
		colors: colors,
		p: [emulator.p[0].slice(), emulator.p[1].slice()],
		hires: emulator.hires,
	};
}

////////////////////////////////////
//
//   Audio Playback
//
////////////////////////////////////

var audio;
var audioNode;
var audioSource;
var audioData;

var AudioBuffer = function(buffer, duration) {
	if (!(this instanceof AudioBuffer)) {
		return new AudioBuffer(buffer, duration);
	}

	this.pointer = 0;
	this.buffer = buffer;
	this.duration = duration;
}

AudioBuffer.prototype.write = function(buffer, index, size) {
	size = Math.max(0, Math.min(size, this.duration))
	if (!size) { return size; }

	this.duration -= size;
	var bufferSize = this.buffer.length;
	var end = index + size;

	for(var i = index; i < end; ++i) {
		buffer[i] = this.buffer[this.pointer++];
		this.pointer %= bufferSize;
	}

	return size;
}

AudioBuffer.prototype.dequeue = function(duration) {
	this.duration -= duration;
}

var FREQ = 4000;
var TIMER_FREQ = 60;
var SAMPLES = 16;
var BUFFER_SIZE = SAMPLES * 8

function audioSetup() {
	if (!audio) {
		if (typeof AudioContext !== 'undefined') {
			audio = new AudioContext();
		}
		else if (typeof webkitAudioContext !== 'undefined') {
			audio = new webkitAudioContext();
		}
	}
	if (audio && !audioNode) {
		audioNode = audio.createScriptProcessor(4096, 1, 1);
		audioNode.onaudioprocess = function(audioProcessingEvent) {
			var outputBuffer = audioProcessingEvent.outputBuffer;
			var outputData = outputBuffer.getChannelData(0);
			var samples_n = outputBuffer.length;

			var index = 0;
			while(audioData.length && index < samples_n) {
				var size = samples_n - index;
				var written = audioData[0].write(outputData, index, size);
				index += written;
				if (written < size) {
					audioData.shift();
				}
			}

			while(index < samples_n) {
				outputData[index++] = 0;
			}
			//the last one can be long sound with high value of buzzer, so always keep it
			if (audioData.length > 1) {
				var audioDataSize = 0;
				var audioBufferSize = audioNode.bufferSize;
				audioData.forEach(function(buffer) { audioDataSize += buffer.duration; })
				while(audioDataSize > audioBufferSize && audioData.length > 1) {
					audioDataSize -= audioData.shift().duration;
				}
			}
		}
		audioData = [];
		audioNode.connect(audio.destination);
		return true;
	}
	if (audio && audioNode) { return true; }
	return false;
}

function stopAudio() {
	if (!audio) { return; }
	if (audioNode) {
		audioNode.disconnect();
		audioNode = null;
	}
	audioData = [];
}

var VOLUME = 0.25;

function playPattern(soundLength, buffer, remainingTicks) {
	if (!audio) { return; }

	var samples = Math.floor(BUFFER_SIZE * audio.sampleRate / FREQ);
	var audioBuffer = new Array(samples);
	if (remainingTicks && audioData.length > 0) {
		audioData[audioData.length - 1].dequeue(Math.floor(remainingTicks * audio.sampleRate / TIMER_FREQ));
	}

	for(var i = 0; i < samples; ++i) {
		var srcIndex = Math.floor(i * FREQ / audio.sampleRate);
		var cell = srcIndex >> 3;
		var bit = srcIndex & 7;
		audioBuffer[i] = (buffer[srcIndex >> 3] & (0x80 >> bit)) ? VOLUME: 0;
	}
	audioData.push(new AudioBuffer(audioBuffer, Math.floor(soundLength * audio.sampleRate / TIMER_FREQ)));
}

function escapeHtml(str) {
    var div = document.createElement('div');
    div.appendChild(document.createTextNode(str));
    return div.innerHTML;
}
</script>
<script>/**
* Adaptive Input
**/

const ael = (element, event, listener) => element.addEventListener   (event, listener, { passive:false })
const rel = (element, event, listener) => element.removeEventListener(event, listener, { passive:false })
const pd  = event => (event.preventDefault(),event.stopPropagation())

const VIP_HEX  = '123c456d789ea0bf'.split('')
const VIP_KEYS = VIP_HEX.map(x => parseInt(x,16))

const GAMEPAD_STYLES = `
.gamepad{
  position:absolute;
  top:10%;
  left:0px;
  width:100%;
  height:90%;
  opacity:0.3;
  user-select: none;
  -webkit-user-select: none;
}
.gamepad .dpad{
  position:absolute;
  bottom: 50px;
  left:   50px;
  width:  250px;
  height: 250px;
  background: gray;
  border-radius: 50%;
  overflow:hidden;
}
.gamepad .stick{
  display:none;
  position:absolute;
  border-radius: 50%;
  width:100px;
  height:100px;
  margin-left:-50px;
  margin-top:-50px;
}
.gamepad .buttons{
  position:absolute;
  bottom: 50px;
  right:  50px;
  width:  250px;
  height: 250px;
}
.gamepad .gamebutton{
  position:absolute;
  width:  125px;
  height: 125px;
  background:gray;
  border-radius:50%;
  overflow:hidden;
  line-height: 125px;
  font-size:50px;
  font-weight:bold;
  color:darkgray;
  text-align:center;
}
.gamepad .dpad.active .stick {display:block;background:#444}
.gamepad .gamebutton.active{background:#444;}
.gamepad .gamebutton.b{left:0;bottom:0;}
.gamepad .gamebutton.a{right:0;top:0;}
`
const VIP_STYLES = `
.vip-pad {display:flex;flex-direction:column;align-items:center;z-index:2000;}
.vip-pad .keypad {display:flex;flex-direction:column;margin-top:10px;}
.vip-pad .keypad>div {display:flex;flex-direction:row;}
.vip-pad .keypad>div>div {
  -webkit-user-select: none;
  user-select: none;
  background:gray;
  width: 100px;
  height: 51px;
  display: flex;
  justify-content: center;
  align-items: center;
  margin: 1px;
}
.vip-pad .keypad>div>div:active,
.vip-pad .keypad>div>div.active {background:black; border:1px solid white;margin:0px;}
`

const INPUT_MODULES = {
  /**
  * An invisible set of gesture recognizers,
  * giving directional input and an action for taps.
  **/
  swipe: {
    install: (screen,up,down,options) => {

      let vdirs      = []
      let direction  = { i:null, sx:0, sy:0, lx:0, ly:0 }
      let action1    = {}
      let taptimeout = null

      const updateStick = _ => {
        // find the relative position of the stick to its starting point
        const cx = direction.lx - direction.sx
        const cy = direction.ly - direction.sy

        // update the virtual direction buttons
        let t = []
        const DEAD_ZONE = 30
        if (Math.abs(cx) > DEAD_ZONE) t.push(cx < 0 ? options.left : options.right)
        if (Math.abs(cy) > DEAD_ZONE) t.push(cy < 0 ? options.up   : options.down)
        vdirs.forEach(x => (t    .indexOf(x)<0) && up  (x)) // clear keys no longer held
        t    .forEach(x => (vdirs.indexOf(x)<0) && down(x)) // push keys that were not held before
        vdirs = t
      }
      const tapDown= i => {
        if (Object.keys(action1).length == 0) down(options.action1)
        action1[i] = true
        if (i == direction.i) { direction = { i:null, sx:0, sy:0, lx:0, ly:0 } }
        taptimeout = null
      }
      const start = e => {
        const t = e.touches[0]
        const i = t.identifier
        // a single-touch is either directional or a tap...
        if (direction.i != null) {
          tapDown(i)
        }
        else {
          direction.i  = i
          direction.sx = t.clientX
          direction.sy = t.clientY
          direction.lx = t.clientX
          direction.ly = t.clientY
          taptimeout = setTimeout(_ => tapDown(i), 100)
        }
        updateStick(),pd(e)
      }
      const move = e => {
        for(let z = 0; z < e.changedTouches.length; z++) {
          const t = e.changedTouches[z]
          const i = t.identifier
          if (i == direction.i) {
            if (taptimeout != null) { clearTimeout(taptimeout); taptimeout = null }
            direction.lx = t.clientX
            direction.ly = t.clientY
          }
        }
        updateStick(),pd(e)
      }
      const end = e => {
        let r1 = false
        for(let z = 0; z < e.changedTouches.length; z++) {
          const t = e.changedTouches[z]
          const i = t.identifier
          if (i == direction.i) {
            if (taptimeout != null) {
              // cancel a short tap
              clearTimeout(taptimeout); taptimeout = null
              down(options.action1)
              setTimeout(_ => up(options.action1), 50)
            }
            direction = { i:null, sx:0, sy:0, lx:0, ly:0 }
          }
          if (i in action1) {
            delete action1[i]
            r1=true
          }
        }
        if (r1 && Object.keys(action1).length == 0) up(options.action1)
        updateStick(),pd(e)
      }
      ael(screen, 'touchstart', start)
      ael(screen, 'touchmove',  move)
      ael(screen, 'touchend',   end)
      screen.uninstallSwipe = _ => {
        rel(screen, 'touchstart', start)
        rel(screen, 'touchmove',  move)
        rel(screen, 'touchend',   end)
      }
    },
    remove: (screen) => {
      screen.uninstallSwipe()
      delete screen.uninstallSwipe
    }
  },

  /**
  * A virtual gamepad overlay with two remappable action keys.
  **/
  gamepad: {
    install: (screen,up,down,options) => {
      // build the UI
      if (document.querySelector('.gamepad')) return
      const root = document.createElement('div')
      root.classList.add('gamepad')
      root.innerHTML = `
      <div class='dpad'><div class='stick'></div></div>
      <div class='buttons'><div class='gamebutton b'>B</div><div class='gamebutton a'>A</div></div>
      <style>${GAMEPAD_STYLES}</style>`
      screen.parentElement.append(root)

      let vdirs      = []
      let directions = {}
      let buttons    = {}
      const pad   = document.querySelector('.gamepad .dpad')
      const stick = document.querySelector('.gamepad .dpad .stick')
      const a     = document.querySelector('.gamepad .gamebutton.a')
      const b     = document.querySelector('.gamepad .gamebutton.b')

      const updateStick = _ => {
        // find centroid of d-pad touchpoints ({0,0} if no touchpoints)
        const touches = Object.values(directions)
        let cx = 0, cy = 0, r = pad.getBoundingClientRect(), sr = stick.getBoundingClientRect()
        touches.forEach(t => (cx+=t.x, cy+=t.y))
        cx /= touches.length,         cy /= touches.length
        cx -= (r.left + (r.width/2)), cy -= (r.top + (r.height/2))

        // position the virtual stick, clamped within dpad
        const ca = Math.atan2(cy, cx)
        const cd = Math.min(Math.sqrt(cx*cx + cy*cy), (r.width/2)-(sr.width/2))
        stick.style.left = ((Math.cos(ca)*cd)+(r.width /2)|0)+'px'
        stick.style.top  = ((Math.sin(ca)*cd)+(r.height/2)|0)+'px'

        // update the virtual direction buttons
        let t = []
        const DEAD_ZONE = 30
        if (Math.abs(cx) > DEAD_ZONE) t.push(cx < 0 ? options.left : options.right)
        if (Math.abs(cy) > DEAD_ZONE) t.push(cy < 0 ? options.up   : options.down)
        vdirs.forEach(x => (t    .indexOf(x)<0) && up  (x)) // clear keys no longer held
        t    .forEach(x => (vdirs.indexOf(x)<0) && down(x)) // push keys that were not held before
        vdirs = t
      }

      const start = e => {
        for(let z = 0; z<e.touches.length; z++) {
          const t = e.touches[z]
          const i = t.identifier
          if (t.target == a) {
            t.target.classList.add('active')
            buttons[i]=options.action1
            down(options.action1)
          }
          if (t.target == b) {
            t.target.classList.add('active')
            buttons[i]=options.action2
            down(options.action2)
          }
          if (t.target == pad) {
            t.target.classList.add('active')
            directions[i]={x:t.clientX, y:t.clientY}
          }
        }
        updateStick(),pd(e)
      }
      const move = e => {
        for(let z = 0; z<e.changedTouches.length; z++) {
          const t = e.changedTouches[z]
          const i = t.identifier
          if (i in directions) directions[i]={x:t.clientX, y:t.clientY}
        }
        updateStick(),pd(e)
      }
      const end = e => {
        for(let z = 0; z<e.changedTouches.length; z++) {
          const t = e.changedTouches[z]
          const i = t.identifier
          if (i in buttons) {
            t.target.classList.remove('active')
            up(buttons[i])
            delete buttons[i]
          }
          if (i in directions) {
            t.target.classList.remove('active')
            delete directions[i]
          }
        }
        updateStick(),pd(e)
      }

      ael(a,   'touchstart', start)
      ael(a,   'touchend',   end  )
      ael(b,   'touchstart', start)
      ael(b,   'touchend',   end  )
      ael(pad, 'touchstart', start)
      ael(pad, 'touchmove',  move )
      ael(pad, 'touchend',   end  )
    },
    remove: (screen) => {
      document.querySelector('.gamepad').remove()
    },
  },

  /**
  * Treat the entire screen, or a centered square region, as invisible buttons,
  * mapped out in the order of the VIP hex keypad.
  **/
  seg16: {
    install: (screen,up,down,options) => {
      const tmap = {}
      const pointToKey = touch => {
        // poll this for each point, as it may vary over time,
        // and experimentally it's never right initially...
        const r = screen.getBoundingClientRect()
        if (options.mode == 'center') {
          if (r.width > r.height) { r.x += (r.width - r.height)/2; r.width = r.height }
          else                    { r.y += (r.height - r.width)/2; r.height = r.width }
        }
        const x = touch.clientX - r.x
        const y = touch.clientY - r.y
        if (x < 0 || x > r.width || y < 0 || y > r.height) return null
        const tx = Math.floor(x / (r.width /4))
        const ty = Math.floor(y / (r.height/4))
        return VIP_KEYS[tx + (4 * ty)]
      }
      const start = e => {
        for(let z=0; z<e.touches.length; z++) {
          const i = e.touches[z].identifier
          const k = pointToKey(e.touches[z])
          if (k != null) down(k)
          tmap[i]=k
        }
        pd(e)
      }
      const move = e => {
        for(let z=0; z<e.touches.length; z++) {
          const i = e.touches[z].identifier
          const k = pointToKey(e.touches[z])
          if (tmap[i] == k) continue       // same cell, nothing to do.
          if (tmap[i] != null) up(tmap[i]) // release old key, if any
          if (k != null)       down(k)     // press new key, if any
          tmap[i]=k
        }
        pd(e)
      }
      const end = e => {
        for(let z=0; z<e.changedTouches.length; z++) {
          const i = e.changedTouches[z].identifier
          const k = pointToKey(e.changedTouches[z])
          if (tmap[i] != null) up(tmap[i])
          tmap[i]=null
        }
        pd(e)
      }
      ael(screen, 'touchstart', start)
      ael(screen, 'touchmove',  move )
      ael(screen, 'touchend',   end  )
      screen.uninstallSeg16 = _ => {
        rel(screen, 'touchstart', start)
        rel(screen, 'touchmove',  move )
        rel(screen, 'touchend',   end  )
      }
    },
    remove:  (screen) => {
      screen.uninstallSeg16()
      delete screen.uninstallSeg16
    },
  },

  /**
  * Provide a visible 4x4 representation of the VIP hex keypad.
  **/
  vip: {
    install: (screen,up,down,options) => {
      if (document.querySelector('.vip-pad')) return
      const root = document.createElement('div')
      root.classList.add('vip-pad')
      root.innerHTML = `<div class='keypad'>
        ${[0,1,2,3].map(r=>`<div>${[0,1,2,3].map(c=>`<div>${VIP_HEX[c+(r*4)].toUpperCase()}</div>`).join('')}</div>`).join('')}
      </div>
      <style>${VIP_STYLES}</style>`
      if (screen.parentElement == document.body) { screen.parentElement.append(root) }
      else { screen.parentElement.parentElement.append(root) }
      const buttons = []
      document.querySelectorAll('.vip-pad .keypad>div>div').forEach(x=>buttons.push(x)) // make an actual Array
      const held = {}
      const start = e => {
        for(let z=0; z<e.touches.length; z++) {
          const t = e.touches[z]
          const i = t.identifier
          const k = VIP_KEYS[buttons.indexOf(t.target)]
          t.target.classList.add('active')
          down(k)
          held[i]=k
        }
        pd(e)
      }
      const end = e => {
        for(let z = 0; z<e.changedTouches.length; z++) {
          const t = e.changedTouches[z]
          const i = t.identifier
          if (held[i]) { up(held[i]); delete held[i] }
          t.target.classList.remove('active')
        }
        pd(e)
      }
      buttons.forEach(b => {
        ael(b, 'touchstart', start)
        ael(b, 'touchend',   end  )
      })
    },
    remove:  (screen) => {
      document.querySelector('.vip-pad').remove()
    },
  },
}

let adaptiveControlsInstalled = null

function injectAdaptiveControls(type, screen, keyup, keydown) {
  let options = {
    up:      5,
    down:    8,
    left:    7,
    right:   9,
    action1: 6,
    action2: 4,
    mode:    'center', // or 'fill', used by seg16
  }
  const lookup = vk => Object.keys(keymap[vk])[0]
  const install = _ => {
    rel(screen, 'touchstart', install)
    adaptiveControlsInstalled = type
    INPUT_MODULES[type].install(
      screen,
      key => keyup  ({ key:lookup(key), preventDefault:_=>_ }),
      key => keydown({ key:lookup(key), preventDefault:_=>_ }),
      options
    )
  }
  // uninstall anything that's already there:
  rel(screen, 'touchstart', install)
  if (adaptiveControlsInstalled) INPUT_MODULES[adaptiveControlsInstalled].remove(screen)

  if (type == 'none') return
  if (type == 'seg16fill') { type='seg16'; options.mode='fill' }
  // defer installing adaptive input until we actually see
  // an input event from the user:
  ael(screen, 'touchstart', install)
}
</script>
<body><canvas id='target' width=512 height=256></canvas></body>
<style>body{margin:0px;display:flex;flex-direction:column;align-items:center;justify-content:center;height:100%;}</style>
<script>
const emulator = new Emulator()
unpackOptions(emulator, data.options)
setRenderTarget(data.options.displayScale || 4, 'target')
emulator.init({rom:data.rom})
emulator.importFlags = _ => getPref('octoFlagRegisters')
emulator.exportFlags = f => setPref('octoFlagRegisters',f)
emulator.buzzTrigger = (ticks,rest)=> playPattern(ticks, emulator.pattern, rest)
const kd = e=>{
	if (!audio) audioSetup()
	if (!(e.key in emulator.keys)) emulator.keys[e.key]=true
	e.preventDefault()
}
const ku = e=>{
	if (e.key in emulator.keys) delete emulator.keys[e.key]
	if (!emulator.waiting) return
	const kindex = keymapInverse[e.key]
	if (kindex != undefined) {
		emulator.waiting = false
		emulator.v[emulator.waitReg] = kindex
	}
	e.preventDefault()
}
window.addEventListener('keydown',kd,false)
window.addEventListener('keyup',ku,false)
intervalHandle = setInterval(_=>{
	if (emulator.halted) return
	for(var z = 0; (z<emulator.tickrate) && (!emulator.waiting); z++) emulator.tick()
	if (emulator.dt > 0) emulator.dt--
	if (emulator.st > 0) emulator.st--
	renderDisplay(emulator)
	document.body.style.backgroundColor = emulator.st?emulator.buzzColor:emulator.quietColor
}, 1000/60)

injectAdaptiveControls(emulator.touchInputMode,document.getElementById('target'),ku,kd)
</script>
